import FreeCAD, Part, PartDesign
from FreeCAD import Base
import InvoluteGear

doc = FreeCAD.ActiveDocument

# ساخت استوانه و برش آن (همانند قبل)
cylinder = doc.addObject("Part::Cylinder", "SolidCylinder")
cylinder.Height = 80.0
cylinder.Radius = 8.0
cut_tool = doc.addObject("Part::Box", "CuttingTool")
cut_tool.Length = 50.0
cut_tool.Width = 50.0
cut_tool.Height = 100.0
cut_tool.Placement = Base.Placement(Base.Vector(5, -25, -10), Base.Rotation(0, 0, 0), Base.Vector(0, 0, 0))
cut_result = doc.addObject("Part::Cut", "CutResult")
cut_result.Base = cylinder
cut_result.Tool = cut_tool
doc.recompute()

# ساخت چرخ دنده با تنظیمات دقیقتر
gear = doc.addObject("Part::FeaturePython", "InvoluteGear")
InvoluteGear._InvoluteGear(gear)
gear.NumberOfTeeth = 10
gear.Modules = '0.5 mm'  # کاهش مدول برای تناسب با اندازه قطعه
gear.PressureAngle = '20 deg'
gear.Placement = Base.Placement(
    Base.Vector(5, 0, 40),
    Base.Rotation(0, 90, 0),
    Base.Vector(0, 0, 0)
)
doc.recompute()

# بررسی هندسه قبل از ادغام
if cut_result.Shape.isValid() and gear.Shape.isValid():
    # ایجاد یک Part::Compound موقت برای بررسی برخورد
    temp_compound = doc.addObject("Part::Compound", "TempCompound")
    temp_compound.Links = [cut_result, gear]
    doc.recompute()
    
    # اگر Compound ساخته شد، ادامه می‌دهیم
    if temp_compound.Shape.isValid():
        # ادغام با استفاده از Part::MultiFuse
        fused_gear = doc.addObject("Part::MultiFuse", "GearFusion")
        fused_gear.Shapes = [cut_result, gear]
        doc.recompute()
        
        # مخفی کردن اشیاء موقت
        temp_compound.ViewObject.Visibility = False
        gear.ViewObject.Visibility = False
        cut_result.ViewObject.Visibility = False
    else:
        FreeCAD.Console.PrintError("Error: Objects cannot be combined in a compound\n")
else:
    FreeCAD.Console.PrintError("Error: Invalid geometry in input objects\n")

FreeCADGui.ActiveDocument.ActiveView.fitAll()
