import { world, system, Player } from '@minecraft/server';
import { ActionFormData } from '@minecraft/server-ui';

// ==================== سیستم اصلی ====================
class DistanceTrackerHUD {
    constructor() {
        this.trackingData = new Map(); // playerId -> targetData
        this.hudPlayers = new Set(); // players with active HUD
        this.updateInterval = null;
        
        // تنظیمات نمایش
        this.hudPosition = 'below_coords'; // 'below_coords', 'top_right', 'above_hotbar'
        this.updateRate = 20; // هر 1 ثانیه (20 تیک)
    }
    
    // شروع ترک
    async startTracking(player, targetName) {
        const target = this.findPlayer(targetName);
        
        if (!target) {
            player.sendMessage('§cPlayer not found!');
            return false;
        }
        
        if (player.id === target.id) {
            player.sendMessage('§cYou cannot track yourself!');
            return false;
        }
        
        if (this.trackingData.has(player.id)) {
            player.sendMessage('§cYou are already tracking someone! Use /cancel track first.');
            return false;
        }
        
        // ذخیره اطلاعات
        this.trackingData.set(player.id, {
            targetId: target.id,
            targetName: target.name,
            lastKnownPos: target.location,
            dimension: target.dimension.id,
            startTime: Date.now(),
            hudEnabled: true
        });
        
        // فعال کردن HUD
        this.enableHUD(player);
        
        player.sendMessage([
            '§a§l✓ TRACKING ACTIVATED',
            `§7Now tracking: §e${target.name}`,
            `§7Distance will appear below your coordinates`,
            `§7Use §f/cancel track §7to stop`
        ].join('\n'));
        
        return true;
    }
    
    // توقف ترک
    stopTracking(player) {
        if (!this.trackingData.has(player.id)) {
            player.sendMessage('§cYou are not tracking anyone!');
            return false;
        }
        
        const data = this.trackingData.get(player.id);
        this.trackingData.delete(player.id);
        this.disableHUD(player);
        
        player.sendMessage([
            '§c§l✗ TRACKING STOPPED',
            `§7Stopped tracking: §e${data.targetName}`,
            `§7Total tracking time: §f${this.formatDuration(Date.now() - data.startTime)}`
        ].join('\n'));
        
        return true;
    }
    
    // فعال کردن HUD برای بازیکن
    enableHUD(player) {
        this.hudPlayers.add(player.id);
        
        // اگر اینتروال فعال نیست، شروع کن
        if (!this.updateInterval) {
            this.startUpdateLoop();
        }
    }
    
    // غیرفعال کردن HUD
    disableHUD(player) {
        this.hudPlayers.delete(player.id);
        
        // اگر HUD خالی شد، اینتروال رو متوقف کن
        if (this.hudPlayers.size === 0 && this.updateInterval) {
            system.clearRun(this.updateInterval);
            this.updateInterval = null;
        }
        
        // پاک کردن HUD از صفحه
        this.clearHUD(player);
    }
    
    // شروع لوپ آپدیت
    startUpdateLoop() {
        this.updateInterval = system.runInterval(() => {
            this.updateAllHUDs();
        }, this.updateRate);
    }
    
    // آپدیت تمام HUDها
    updateAllHUDs() {
        for (const playerId of this.hudPlayers) {
            const player = world.getPlayer(playerId);
            const data = this.trackingData.get(playerId);
            
            if (!player || !data || !player.isValid()) {
                this.hudPlayers.delete(playerId);
                this.trackingData.delete(playerId);
                continue;
            }
            
            const target = world.getPlayer(data.targetId);
            this.updatePlayerHUD(player, target, data);
        }
    }
    
    // آپدیت HUD یک بازیکن
    updatePlayerHUD(player, target, data) {
        if (!player || !player.isValid()) return;
        
        let hudText = '';
        
        if (!target || !target.isValid()) {
            // هدف پیدا نشد (آفلاین یا در دنیای دیگر)
            hudText = '§7Target offline';
        } else {
            // بررسی ابعاد
            const playerDim = player.dimension.id;
            const targetDim = target.dimension.id;
            
            if (playerDim !== targetDim) {
                // ابعاد مختلف
                const dimName = this.getDimensionName(targetDim);
                hudText = `§5in ${dimName}`;
                
                // ذخیره آخرین موقعیت شناخته شده
                data.lastKnownPos = target.location;
                data.dimension = targetDim;
            } else {
                // ابعاد یکسان - محاسبه فاصله
                const distance = this.calculateDistance(player.location, target.location);
                const direction = this.getDirection(player.location, target.location);
                
                // نمایش فاصله با رنگ‌های مختلف بر اساس نزدیکی
                let color = '§a'; // سبز برای دور
                if (distance < 50) color = '§e'; // زرد
                if (distance < 20) color = '§c'; // قرمز
                if (distance < 5) color = '§4'; // قرمز تیره
                
                hudText = `${color}${Math.round(distance)} blocks §7${direction}`;
                
                // آپدیت آخرین موقعیت شناخته شده
                data.lastKnownPos = target.location;
            }
        }
        
        // نمایش HUD
        this.displayHUD(player, hudText, data.targetName);
    }
    
    // نمایش HUD روی صفحه
    displayHUD(player, distanceText, targetName) {
        // سه روش برای نمایش HUD:
        
        // 1. استفاده از title (بهترین روش - مشابه کوردینیت)
        try {
            player.onScreenDisplay.setTitle(`§7Tracking §e${targetName}§r\n${distanceText}`, {
                stayDuration: 22, // کمی بیشتر از 1 ثانیه
                fadeInDuration: 0,
                fadeOutDuration: 0,
                subtitle: true // نمایش به عنوان ساب‌تایتل
            });
        } catch (e) {
            // 2. اگر بالا کار نکرد، از action bar استفاده کن
            player.onScreenDisplay.setActionBar(`§7${targetName}: ${distanceText}`);
        }
    }
    
    // پاک کردن HUD
    clearHUD(player) {
        try {
            player.onScreenDisplay.setTitle('', {
                stayDuration: 1,
                fadeInDuration: 0,
                fadeOutDuration: 0
            });
        } catch (e) {
            // روش جایگزین
            player.onScreenDisplay.setActionBar('');
        }
    }
    
    // پیدا کردن بازیکن
    findPlayer(name) {
        const players = [...world.getPlayers()];
        return players.find(p => 
            p.name.toLowerCase() === name.toLowerCase() ||
            p.name.toLowerCase().includes(name.toLowerCase())
        );
    }
    
    // محاسبه فاصله افقی (X و Z)
    calculateDistance(pos1, pos2) {
        const dx = pos2.x - pos1.x;
        const dz = pos2.z - pos1.z;
        return Math.sqrt(dx * dx + dz * dz);
    }
    
    // گرفتن جهت (N, NE, E, SE, S, SW, W, NW)
    getDirection(pos1, pos2) {
        const dx = pos2.x - pos1.x;
        const dz = pos2.z - pos1.z;
        
        // محاسبه زاویه
        let angle = Math.atan2(dz, dx) * (180 / Math.PI);
        angle = (angle + 90 + 360) % 360; // تنظیم به شمال = 0 درجه
        
        // تبدیل به جهت
        const directions = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'];
        const index = Math.round(angle / 45) % 8;
        
        return directions[index];
    }
    
    // گرفتن نام خوانا برای بعد
    getDimensionName(dimensionId) {
        const dimMap = {
            'minecraft:overworld': 'Overworld',
            'minecraft:nether': 'Nether',
            'minecraft:the_end': 'End'
        };
        return dimMap[dimensionId] || dimensionId.replace('minecraft:', '');
    }
    
    // فرمت کردن زمان
    formatDuration(ms) {
        const seconds = Math.floor(ms / 1000);
        const minutes = Math.floor(seconds / 60);
        const hours = Math.floor(minutes / 60);
        
        if (hours > 0) return `${hours}h ${minutes % 60}m`;
        if (minutes > 0) return `${minutes}m ${seconds % 60}s`;
        return `${seconds}s`;
    }
    
    // نمایش لیست بازیکنان برای ترک
    async showPlayerList(player) {
        const players = [...world.getPlayers()].filter(p => p.id !== player.id);
        
        if (players.length === 0) {
            player.sendMessage('§cNo other players online to track!');
            return null;
        }
        
        const form = new ActionFormData();
        form.title('§6§lTrack Player');
        form.body('§7Select a player to track:\n\n§8Online Players: ' + players.length);
        
        players.forEach(p => {
            form.button(`§7${p.name}\n§8Click to track`);
        });
        
        form.button('§cCancel');
        
        try {
            const response = await form.show(player);
            if (response.canceled || response.selection === players.length) return null;
            return players[response.selection];
        } catch (e) {
            console.error('Form error:', e);
            return null;
        }
    }
}

// ==================== سیستم کامند ====================
class CommandHandler {
    constructor(tracker) {
        this.tracker = tracker;
        this.setupCommands();
    }
    
    setupCommands() {
        // هندلر کامند چت
        world.beforeEvents.chatSend.subscribe((event) => {
            const message = event.message;
            const player = event.sender;
            
            // کامند /track
            if (message.startsWith('/track ')) {
                event.cancel = true;
                const targetName = message.split(' ').slice(1).join(' ');
                
                if (targetName.trim() === '') {
                    // اگر نام نداد، لیست نشون بده
                    this.tracker.showPlayerList(player).then(target => {
                        if (target) {
                            this.tracker.startTracking(player, target.name);
                        }
                    });
                } else {
                    this.tracker.startTracking(player, targetName);
                }
            }
            
            // کامند /cancel track
            else if (message === '/cancel track' || message === '/untrack') {
                event.cancel = true;
                this.tracker.stopTracking(player);
            }
            
            // کامند /tracklist
            else if (message === '/tracklist') {
                event.cancel = true;
                this.showTrackList(player);
            }
            
            // کامند /trackhelp
            else if (message === '/trackhelp') {
                event.cancel = true;
                this.showHelp(player);
            }
            
            // کامند /trackhud (تغییر موقعیت HUD)
            else if (message.startsWith('/trackhud ')) {
                event.cancel = true;
                this.changeHUDPosition(player, message);
            }
        });
    }
    
    // نمایش لیست ترک‌های فعال
    showTrackList(player) {
        const trackList = [];
        
        for (const [trackerId, data] of this.tracker.trackingData) {
            const tracker = world.getPlayer(trackerId);
            const target = world.getPlayer(data.targetId);
            
            if (tracker && target) {
                const distance = this.tracker.calculateDistance(
                    tracker.location, 
                    target.location
                );
                trackList.push(`§7${tracker.name} §8→ §e${target.name} §7(${Math.round(distance)} blocks)`);
            }
        }
        
        if (trackList.length > 0) {
            player.sendMessage([
                '§6§lActive Tracking Sessions:',
                ...trackList,
                `§8Total: §7${trackList.length} active tracking`
            ].join('\n'));
        } else {
            player.sendMessage('§7No active tracking sessions.');
        }
    }
    
    // تغییر موقعیت HUD
    changeHUDPosition(player, message) {
        const position = message.split(' ')[1];
        const positions = ['below', 'top', 'hotbar'];
        
        if (positions.includes(position)) {
            this.tracker.hudPosition = position;
            player.sendMessage(`§aHUD position changed to: §f${position}`);
        } else {
            player.sendMessage([
                '§cInvalid position!',
                '§7Available positions:',
                '§fbelow §7- Below coordinates (default)',
                '§ftop §7- Top right corner',
                '§fhotbar §7- Above hotbar'
            ].join('\n'));
        }
    }
    
    // نمایش راهنما
    showHelp(player) {
        const helpText = [
            '§6§lDistance Tracker HUD - Help',
            '§7Commands:',
            '§e/track [name] §8- Start tracking a player',
            '§e/track §8- Show player list to select',
            '§e/cancel track §8- Stop tracking',
            '§e/untrack §8- Alias for /cancel track',
            '§e/tracklist §8- Show active tracking sessions',
            '§e/trackhud [pos] §8- Change HUD position',
            '§e/trackhelp §8- Show this help',
            '',
            '§7Features:',
            '§8• §fReal-time distance display',
            '§8• §fDirection indicator (N, NE, E, etc.)',
            '§8• §fCross-dimension detection',
            '§8• §fColor-coded distance (green → red)',
            '§8• §fPersistent until /cancel track',
            '',
            '§7When target is in another dimension:',
            '§8• §fDisplays "in Nether", "in End", etc.',
            '§8• §fAuto-resumes when same dimension'
        ];
        
        player.sendMessage(helpText.join('\n'));
    }
}

// ==================== هندلرهای رویداد ====================
class EventHandlers {
    constructor(tracker) {
        this.tracker = tracker;
        this.setupEvents();
    }
    
    setupEvents() {
        // هندلر خروج بازیکن
        world.afterEvents.playerLeave.subscribe((event) => {
            const playerId = event.playerId;
            
            // اگر این بازیکن کسی رو ترک می‌کرد
            if (this.tracker.trackingData.has(playerId)) {
                this.tracker.stopTracking(world.getPlayer(playerId));
            }
            
            // اگر کسی این بازیکن رو ترک می‌کرد
            for (const [trackerId, data] of this.tracker.trackingData) {
                if (data.targetId === playerId) {
                    const tracker = world.getPlayer(trackerId);
                    if (tracker) {
                        tracker.sendMessage(`§cTarget player left the server. Tracking stopped.`);
                        this.tracker.stopTracking(tracker);
                    }
                }
            }
        });
        
        // هندلر تغییر بعد
        world.afterEvents.playerDimensionChange.subscribe((event) => {
            const player = event.player;
            
            // بررسی آیا این بازیکن کسی رو ترک می‌کنه
            if (this.tracker.trackingData.has(player.id)) {
                const data = this.tracker.trackingData.get(player.id);
                const target = world.getPlayer(data.targetId);
                
                if (target && target.dimension.id === player.dimension.id) {
                    // اگر هر دو در یک بعد هستند، ترک ادامه پیدا می‌کنه
                    player.sendMessage(`§aBoth in ${this.tracker.getDimensionName(player.dimension.id)} - Tracking resumed!`);
                }
            }
            
            // بررسی آیا کسی این بازیکن رو ترک می‌کنه
            for (const [trackerId, data] of this.tracker.trackingData) {
                if (data.targetId === player.id) {
                    const tracker = world.getPlayer(trackerId);
                    if (tracker && tracker.dimension.id === player.dimension.id) {
                        tracker.sendMessage(`§aTarget is now in ${this.tracker.getDimensionName(player.dimension.id)} - Tracking resumed!`);
                    }
                }
            }
        });
    }
}

// ==================== INITIALIZATION ====================
const tracker = new DistanceTrackerHUD();
const commandHandler = new CommandHandler(tracker);
const eventHandlers = new EventHandlers(tracker);

// پیغام شروع
system.run(() => {
    console.log('§a[Distance Tracker HUD] System initialized!');
    world.sendMessage('§7[Distance Tracker] §fType §e/trackhelp §ffor commands');
});

// هندلر تیک برای آپدیت مداوم HUD
system.runInterval(() => {
    tracker.updateAllHUDs();
}, 20);

// هندلر تست/دیباگ (اختیاری)
world.afterEvents.chatSend.subscribe((event) => {
    if (event.message === '!trackdebug') {
        const player = event.sender;
        player.sendMessage([
            `§6Tracking Debug Info:`,
            `§7Active trackers: §f${tracker.trackingData.size}`,
            `§7HUD players: §f${tracker.hudPlayers.size}`,
            `§7Update interval: §f${tracker.updateRate} ticks`
        ].join('\n'));
    }
});

// ==================== EXPORT ====================
export {
    tracker,
    commandHandler,
    eventHandlers
};
