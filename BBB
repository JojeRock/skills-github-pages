<?php
/* ==================== ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù¾Ø§ÛŒÙ‡ ==================== */
ini_set('display_errors', 0);
ini_set('log_errors', 1);
ini_set('error_log', __DIR__.'/error.log');
error_reporting(E_ALL);

// Ø§ÛŒØ¬Ø§Ø¯ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¶Ø±ÙˆØ±ÛŒ
$required_files = [
    'members.txt' => '',
    'membersRecent.txt' => '',
    'groups.txt' => '',
    'step.txt' => 'none',
    'lockChannel.txt' => 'yes',
    'bot_status.txt' => 'on',
    'error.log' => '',
    'admin_activity.log' => '',
    'user_languages.txt' => ''
];

foreach ($required_files as $file => $content) {
    if (!file_exists($file)) {
        file_put_contents($file, $content);
        chmod($file, 0644);
    }
}

// Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø±Ø¨Ø§Øª
$bot_status = trim(file_get_contents('bot_status.txt'));
if ($bot_status === 'off') {
    $input = file_get_contents('php://input');
    $update = json_decode($input, true);
    $from = $update['message']['from'] ?? $update['edited_message']['from'] ?? $update['callback_query']['from'] ?? null;
    $user_id = $from['id'] ?? null;
   
    if ($user_id != ADMIN_ID) {
        exit();
    }
}

/* ==================== ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø±Ø¨Ø§Øª ==================== */
define('API_KEY', '7491373246:AAEB5GCCyhdkXksAwk0A9heElp4KdIJ4-LA');
define('ADMIN_ID', '5107034738');
define('BOT_USERNAME', 'QRCodeScanerr_bot');
define('CHANNEL', 'JBotss');
define('MAX_FILE_SIZE', 10 * 1024 * 1024);

// API Ù‡Ø§ÛŒ QRCode Ø¬Ø¯ÛŒØ¯ Ø¨Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² qr-code-generator.com
define('QR_API_KEY', '14DwOdfh6ts-QxtAh0KSJhMGn56tidjGRVI93MUaW8fdQZqhuXr6ZDKizZP3UP9V');
define('QR_ENCODE_1', 'https://api.qr-code-generator.com/v1/create?access-token=' . QR_API_KEY);
define('QR_DECODE_1', 'https://api.qr-code-generator.com/v1/reader');

/* ==================== ØªÙˆØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ ==================== */
function bot($method, $data = []) {
    $url = 'https://api.telegram.org/bot' . API_KEY . '/' . $method;
    $ch = curl_init($url);
    curl_setopt_array($ch, [
        CURLOPT_POST => true,
        CURLOPT_RETURNTRANSFER => true,
        CURLOPT_POSTFIELDS => $data,
        CURLOPT_TIMEOUT => 30,
        CURLOPT_SSL_VERIFYPEER => false
    ]);
    
    $result = curl_exec($ch);
    $http_code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    curl_close($ch);
    
    if ($http_code != 200 || !$result) {
        error_log("Telegram API error: Method=$method, HTTP_CODE=$http_code, Response=$result");
    }
    
    return $result ? json_decode($result, true) : false;
}

// ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ø²Ø¨Ø§Ù† Ú©Ø§Ø±Ø¨Ø±
function getUserLanguage($user_id, $from_language_code = 'en') {
    $user_languages = file_get_contents('user_languages.txt');
    $languages = [];
   
    if (!empty($user_languages)) {
        $lines = explode(PHP_EOL, $user_languages);
        foreach ($lines as $line) {
            if (!empty($line)) {
                $parts = explode(':', $line);
                if (count($parts) >= 2) {
                    $id = $parts[0];
                    $lang = $parts[1];
                    $languages[$id] = $lang;
                }
            }
        }
    }
   
    if (isset($languages[$user_id])) {
        return $languages[$user_id];
    }
   
    $user_lang = ($from_language_code == 'fa' || $from_language_code == 'fa-ir') ? 'fa' : 'en';
    $languages[$user_id] = $user_lang;
   
    $user_languages_content = '';
    foreach ($languages as $id => $lang) {
        $user_languages_content .= "$id:$lang" . PHP_EOL;
    }
    file_put_contents('user_languages.txt', $user_languages_content);
   
    return $user_lang;
}

// ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ ØªØ±Ø¬Ù…Ù‡ Ù…ØªÙ†â€ŒÙ‡Ø§
function trans($key, $user_id, $from_language_code = 'en') {
    $lang = getUserLanguage($user_id, $from_language_code);
   
    $translations = [
        'welcome' => [
            'fa' => "ğŸ‘‹ <b>Ø³Ù„Ø§Ù… {name}! Ø¨Ù‡ Ø±Ø¨Ø§Øª QRCode Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯.</b>\n\nğŸ”¹ Ø¯Ø± Ú†Øª Ø®ØµÙˆØµÛŒ Ù‡Ø± Ù…Ø­ØªÙˆØ§ÛŒÛŒ Ø±Ø§ Ø¨Ù‡ QRCode ØªØ¨Ø¯ÛŒÙ„ Ù…ÛŒâ€ŒÚ©Ù†Ù…\nğŸ”¹ Ø¯Ø± Ú¯Ø±ÙˆÙ‡â€ŒÙ‡Ø§ ÙÙ‚Ø· Ø¨Ù‡ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø¯Ø§Ø±Ø§ÛŒ + ÛŒØ§ = Ù¾Ø§Ø³Ø® Ù…ÛŒâ€ŒØ¯Ù‡Ù…\n\nğŸ“Œ Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨ÛŒØ´ØªØ± /help Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯",
            'en' => "ğŸ‘‹ <b>Hello {name}! Welcome to QRCode bot.</b>\n\nğŸ”¹ In private chat I convert any content to QRCode\nğŸ”¹ In groups I only respond to messages with + or =\n\nğŸ“Œ Send /help for more information"
        ],
        'help' => [
            'fa' => "ğŸ¤– <b>Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø±Ø¨Ø§Øª QRCode</b>\n\nğŸ”¸ <b>Ø¯Ø± Ú†Øª Ø®ØµÙˆØµÛŒ:</b>\n - Ù‡Ø± Ù¾ÛŒØ§Ù… ÛŒØ§ Ø±Ø³Ø§Ù†Ù‡â€ŒØ§ÛŒ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯ØŒ Ø±Ø¨Ø§Øª QRCode Ù…ÛŒâ€ŒØ³Ø§Ø²Ø¯\n - ØªØµØ§ÙˆÛŒØ± QR Ú©Ø¯ Ø±Ø§ Ø¨Ù‡ ØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù…ÛŒâ€ŒÚ©Ù†Ø¯\n\nğŸ”¸ <b>Ø¯Ø± Ú¯Ø±ÙˆÙ‡â€ŒÙ‡Ø§:</b>\n - Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø®Øª QRCode: Ù¾ÛŒØ§Ù… Ø±Ø§ Ø¨Ø§ + Ø´Ø±ÙˆØ¹ Ú©Ù†ÛŒØ¯ (Ù…Ø«Ø§Ù„: +Ø³Ù„Ø§Ù…)\n - Ø¨Ø±Ø§ÛŒ Ø®ÙˆØ§Ù†Ø¯Ù† QRCode: ØªØµÙˆÛŒØ± QR Ø±Ø§ Ø¨Ø§ Ú©Ù¾Ø´Ù† = Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯\n - Ø­Ø¯Ø§Ú©Ø«Ø± Ø­Ø¬Ù… ÙØ§ÛŒÙ„: 10 Ù…Ú¯Ø§Ø¨Ø§ÛŒØª\n\nğŸ“£ Ú©Ø§Ù†Ø§Ù„ Ù…Ø§: @{channel}",
            'en' => "ğŸ¤– <b>QRCode Bot Guide</b>\n\nğŸ”¸ <b>In private chat:</b>\n - Send any message or media, bot will create QRCode\n - Automatically processes QR code images\n\nğŸ”¸ <b>In groups:</b>\n - To create QRCode: Start message with + (example: +hello)\n - To read QRCode: Send QR image with caption =\n - Maximum file size: 10MB\n\nğŸ“£ Our channel: @{channel}"
        ],
        'channel_required' => [
            'fa' => "ğŸš¨ Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø§ÛŒÙ† Ù‚Ø§Ø¨Ù„ÛŒØª Ø¨Ø§ÛŒØ¯ Ø¹Ø¶Ùˆ Ú©Ø§Ù†Ø§Ù„ @{channel} Ø¨Ø§Ø´ÛŒØ¯.",
            'en' => "ğŸš¨ To use this feature you must join our channel @{channel}."
        ],
        'file_too_large' => [
            'fa' => "âš ï¸ <b>Ø­Ø¬Ù… ÙØ§ÛŒÙ„ Ø§Ø±Ø³Ø§Ù„ÛŒ Ø¨ÛŒØ´ØªØ± Ø§Ø² 10 Ù…Ú¯Ø§Ø¨Ø§ÛŒØª Ø§Ø³Øª!</b>\nÙ„Ø·ÙØ§ ÙØ§ÛŒÙ„ Ú©ÙˆÚ†Ú©ØªØ±ÛŒ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯.",
            'en' => "âš ï¸ <b>File size exceeds 10MB!</b>\nPlease send a smaller file."
        ],
        'qr_content' => [
            'fa' => "ğŸ” Ù…Ø­ØªÙˆØ§ÛŒ QR Ú©Ø¯:\n\n{content}",
            'en' => "ğŸ” QR code content:\n\n{content}"
        ],
        'qr_not_detected' => [
            'fa' => "âš ï¸ QR Ú©Ø¯ ØªØ´Ø®ÛŒØµ Ø¯Ø§Ø¯Ù‡ Ù†Ø´Ø¯!\n\nØ±Ø§Ù‡Ú©Ø§Ø±Ù‡Ø§:\n1. Ú©ÛŒÙÛŒØª ØªØµÙˆÛŒØ± Ø±Ø§ Ø§ÙØ²Ø§ÛŒØ´ Ø¯Ù‡ÛŒØ¯\n2. Ù†ÙˆØ± Ù…Ø­ÛŒØ· Ø±Ø§ ØªÙ†Ø¸ÛŒÙ… Ú©Ù†ÛŒØ¯\n3. Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒØ¯ Ú©Ù¾Ø´Ù† ÙÙ‚Ø· Ø¹Ù„Ø§Ù…Øª = Ø¨Ø§Ø´Ø¯\n4. ØªØµÙˆÛŒØ± ÙˆØ§Ø¶Ø­ Ùˆ Ø®ÙˆØ§Ù†Ø§ Ø¨Ø§Ø´Ø¯",
            'en' => "âš ï¸ QR code not detected!\n\nSolutions:\n1. Increase image quality\n2. Adjust lighting\n3. Make sure caption is only = symbol\n4. Ensure image is clear and readable"
        ],
        'join_channel' => [
            'fa' => "ğŸ“£ Ø¹Ø¶ÙˆÛŒØª Ø¯Ø± Ú©Ø§Ù†Ø§Ù„",
            'en' => "ğŸ“£ Join Channel"
        ],
        'add_to_group' => [
            'fa' => "â• Ø§ÙØ²ÙˆØ¯Ù† Ø±Ø¨Ø§Øª Ø¨Ù‡ Ú¯Ø±ÙˆÙ‡",
            'en' => "â• Add to Group"
        ],
        'our_channel' => [
            'fa' => "ğŸ“£ Ú©Ø§Ù†Ø§Ù„ Ù…Ø§",
            'en' => "ğŸ“£ Our Channel"
        ],
        'qr_for' => [
            'fa' => "ğŸ”³ QRCode Ø¨Ø±Ø§ÛŒ: {content}",
            'en' => "ğŸ”³ QRCode for: {content}"
        ],
        'admin_panel' => [
            'fa' => "ğŸ§® <b>Ø¨Ù‡ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ø±Ø¨Ø§Øª Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯.</b>",
            'en' => "ğŸ§® <b>Welcome to bot admin panel.</b>"
        ],
        'bot_status_changed' => [
            'fa' => "âœ… Ø±Ø¨Ø§Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª {status} Ø´Ø¯.",
            'en' => "âœ… Bot successfully {status}."
        ],
        'channel_lock_changed' => [
            'fa' => "âœ… ÙˆØ¶Ø¹ÛŒØª Ù‚ÙÙ„ Ú©Ø§Ù†Ø§Ù„ ØªØºÛŒÛŒØ± Ú©Ø±Ø¯: {status}",
            'en' => "âœ… Channel lock status changed: {status}"
        ],
        'stats_message' => [
            'fa' => "ğŸ“Š <b>Ø¢Ù…Ø§Ø± Ø±Ø¨Ø§Øª:</b>\n\nğŸ‘¤ ØªØ¹Ø¯Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†: <b>{users}</b>\nğŸ‘¥ ØªØ¹Ø¯Ø§Ø¯ Ú¯Ø±ÙˆÙ‡â€ŒÙ‡Ø§: <b>{groups}</b>\nğŸ”Œ ÙˆØ¶Ø¹ÛŒØª Ø±Ø¨Ø§Øª: <b>{bot_status}</b>",
            'en' => "ğŸ“Š <b>Bot statistics:</b>\n\nğŸ‘¤ Total users: <b>{users}</b>\nğŸ‘¥ Total groups: <b>{groups}</b>\nğŸ”Œ Bot status: <b>{bot_status}</b>"
        ],
        'broadcast_sent' => [
            'fa' => "âœ… Ù¾ÛŒØ§Ù… Ø¨Ù‡ {count} Ú©Ø§Ø±Ø¨Ø± Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯.",
            'en' => "âœ… Message sent to {count} users."
        ],
        'group_broadcast_sent' => [
            'fa' => "âœ… Ù¾ÛŒØ§Ù… Ø¨Ù‡ {count} Ú¯Ø±ÙˆÙ‡ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯.",
            'en' => "âœ… Message sent to {count} groups."
        ],
        'exit_admin' => [
            'fa' => "âœ… Ø§Ø² Ø­Ø§Ù„Øª Ù…Ø¯ÛŒØ±ÛŒØª Ø®Ø§Ø±Ø¬ Ø´Ø¯ÛŒØ¯.",
            'en' => "âœ… Exited admin mode."
        ]
    ];
   
    $text = $translations[$key][$lang] ?? $translations[$key]['en'] ?? $key;
    $text = str_replace('{channel}', CHANNEL, $text);
   
    return $text;
}

function sendQRCode($chat_id, $content, $reply_to = null, $is_private = false, $user_id = null, $user_lang = 'en') {
    // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² API qr-code-generator.com Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø®Øª QR Ú©Ø¯
    $qr_data = [
        'frame_name' => 'no-frame',
        'qr_code_text' => $content,
        'image_format' => 'PNG',
        'qr_code_logo' => 'none',
        'foreground_color' => '#000000',
        'background_color' => '#ffffff'
    ];
    
    $ch = curl_init(QR_ENCODE_1);
    curl_setopt_array($ch, [
        CURLOPT_POST => true,
        CURLOPT_RETURNTRANSFER => true,
        CURLOPT_TIMEOUT => 30,
        CURLOPT_SSL_VERIFYPEER => false,
        CURLOPT_POSTFIELDS => json_encode($qr_data),
        CURLOPT_HTTPHEADER => [
            'Content-Type: application/json',
            'Accept: application/json'
        ]
    ]);
    
    $response = curl_exec($ch);
    $http_code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    curl_close($ch);
    
    $qr_url = '';
    if ($http_code == 200 && $response) {
        $result = json_decode($response, true);
        if (isset($result['url'])) {
            $qr_url = $result['url'];
        }
    }
    
    // Ø§Ú¯Ø± API Ø¬ÙˆØ§Ø¨ Ù†Ø¯Ø§Ø¯ØŒ Ø§Ø² fallback Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†
    if (empty($qr_url)) {
        $qr_url = 'https://api.qrserver.com/v1/create-qr-code/?size=500x500&data=' . urlencode($content);
    }
   
    $reply_markup = null;
    if ($is_private) {
        $add_text = trans('add_to_group', $user_id, $user_lang);
        $channel_text = trans('our_channel', $user_id, $user_lang);
       
        $reply_markup = json_encode([
            'inline_keyboard' => [
                [
                    ['text' => $add_text, 'url' => 'https://t.me/' . BOT_USERNAME . '?startgroup=true'],
                    ['text' => $channel_text, 'url' => 'https://t.me/' . CHANNEL]
                ]
            ]
        ]);
    }
   
    $caption_text = trans('qr_for', $user_id, $user_lang);
    $caption_text = str_replace('{content}', (mb_strlen($content) > 30 ? mb_substr($content, 0, 30) . '...' : $content), $caption_text);
   
    return bot('sendPhoto', [
        'chat_id' => $chat_id,
        'photo' => $qr_url,
        'reply_to_message_id' => $reply_to,
        'caption' => $caption_text,
        'reply_markup' => $reply_markup,
        'parse_mode' => 'HTML'
    ]);
}

function decodeQRCode($file_id) {
    $file_info = bot('getFile', ['file_id' => $file_id]);
    if (!$file_info || !isset($file_info['result']['file_path'])) {
        error_log("Failed to get file path from Telegram: File ID=$file_id");
        return false;
    }
   
    $file_url = 'https://api.telegram.org/file/bot' . API_KEY . '/' . $file_info['result']['file_path'];
    
    // Ø±ÙˆØ´ Ø§ÙˆÙ„: Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² API qr-code-generator.com
    $temp_file = tempnam(sys_get_temp_dir(), 'qr');
    $file_content = file_get_contents($file_url);
    if ($file_content === false) {
        error_log("Failed to download file from: $file_url");
        return false;
    }
    file_put_contents($temp_file, $file_content);
    
    // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² API Ø§ØµÙ„ÛŒ qr-code-generator.com
    $ch = curl_init();
    curl_setopt_array($ch, [
        CURLOPT_URL => QR_DECODE_1,
        CURLOPT_RETURNTRANSFER => true,
        CURLOPT_TIMEOUT => 30,
        CURLOPT_SSL_VERIFYPEER => false,
        CURLOPT_POST => true,
        CURLOPT_HTTPHEADER => [
            'Content-Type: multipart/form-data',
            'Authorization: Bearer ' . QR_API_KEY
        ],
        CURLOPT_POSTFIELDS => [
            'file' => new CURLFile($temp_file)
        ]
    ]);
    
    $response = curl_exec($ch);
    $http_code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    $error = curl_error($ch);
    curl_close($ch);
    
    unlink($temp_file); // Ø­Ø°Ù ÙØ§ÛŒÙ„ Ù…ÙˆÙ‚Øª
    
    if ($http_code == 200 && $response && !$error) {
        $result = json_decode($response, true);
        if (isset($result[0]['type']) && $result[0]['type'] == 'qrcode' && isset($result[0]['symbol'][0]['data'])) {
            return $result[0]['symbol'][0]['data'];
        }
        // ÙØ±Ù…Øª Ø¬Ø¯ÛŒØ¯ API
        if (isset($result['code']) && $result['code'] == 200 && isset($result['data'])) {
            return $result['data'];
        }
    }
    
    error_log("QR decode failed with qr-code-generator.com: HTTP_CODE=$http_code, Error=$error, Response=" . substr($response, 0, 200));
    
    // Ø±ÙˆØ´ Ø¯ÙˆÙ…: Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² API Ù‚Ø¯ÛŒÙ…ÛŒ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† fallback
    $ch = curl_init();
    curl_setopt_array($ch, [
        CURLOPT_URL => 'https://api.qrserver.com/v1/read-qr-code/',
        CURLOPT_RETURNTRANSFER => true,
        CURLOPT_TIMEOUT => 30,
        CURLOPT_SSL_VERIFYPEER => false,
        CURLOPT_POST => true,
        CURLOPT_POSTFIELDS => ['fileurl' => $file_url]
    ]);
    
    $response = curl_exec($ch);
    $http_code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    $error = curl_error($ch);
    curl_close($ch);
    
    if ($http_code == 200 && $response && !$error) {
        $result = json_decode($response, true);
        if (isset($result[0]['symbol'][0]['data']) && !empty($result[0]['symbol'][0]['data'])) {
            return $result[0]['symbol'][0]['data'];
        }
    }
    
    error_log("QR decode failed with fallback API: HTTP_CODE=$http_code, Error=$error");
    return false;
}

function showHelp($chat_id, $user_id, $user_lang = 'en') {
    $help_text = trans('help', $user_id, $user_lang);
   
    return bot('sendMessage', [
        'chat_id' => $chat_id,
        'text' => $help_text,
        'parse_mode' => 'HTML',
        'disable_web_page_preview' => true
    ]);
}

function isMember($user_id, $chat_id) {
    // Ø§Ú¯Ø± @ Ù†Ø¯Ø§Ø±Ø¯ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†
    if (strpos($chat_id, '@') === false) {
        $chat_id = '@' . $chat_id;
    }
    
    $result = bot('getChatMember', [
        'chat_id' => $chat_id,
        'user_id' => $user_id
    ]);
    
    if ($result && isset($result['ok']) && $result['ok']) {
        $status = $result['result']['status'] ?? '';
        // Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù Ø¹Ø¶ÙˆÛŒØª
        $is_member = in_array($status, ['creator', 'administrator', 'member', 'restricted']);
        error_log("Membership check: User=$user_id, Channel=$chat_id, Status=$status, IsMember=" . ($is_member ? 'Yes' : 'No'));
        return $is_member;
    }
    
    error_log("Failed to check membership: User=$user_id, Chat=$chat_id, Result=" . json_encode($result));
    return false;
}

function logAdminActivity($action) {
    $log = "[" . date('Y-m-d H:i:s') . "] " . $action . PHP_EOL;
    file_put_contents('admin_activity.log', $log, FILE_APPEND);
}

/* ==================== Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù¾ÛŒØ§Ù… ==================== */
$input = file_get_contents('php://input');
$update = json_decode($input, true);

if (!$update) {
    error_log("Invalid update received");
    exit();
}

$message = $update['message'] ?? $update['edited_message'] ?? $update['channel_post'] ?? $update['callback_query']['message'] ?? null;
$from = $update['message']['from'] ?? $update['edited_message']['from'] ?? $update['callback_query']['from'] ?? null;
$chat = $update['message']['chat'] ?? $update['edited_message']['chat'] ?? $update['callback_query']['message']['chat'] ?? null;

$user_id = $from['id'] ?? null;
$first_name = $from['first_name'] ?? '';
$last_name = $from['last_name'] ?? '';
$full_name = trim("$first_name $last_name");
$chat_id = $chat['id'] ?? null;
$chat_type = $chat['type'] ?? 'private';
$message_id = $update['message']['message_id'] ?? $update['callback_query']['message']['message_id'] ?? null;
$message_text = $update['message']['text'] ?? $update['callback_query']['data'] ?? null;
$caption = $update['message']['caption'] ?? null;
$language_code = $from['language_code'] ?? 'en';

$content_type = null;
$file_id = null;
$file_size = 0;

if (isset($update['message']['photo'])) {
    $photos = $update['message']['photo'];
    $file_id = end($photos)['file_id'];
    $file_size = end($photos)['file_size'] ?? 0;
    $content_type = 'photo';
} elseif (isset($update['message']['video'])) {
    $file_id = $update['message']['video']['file_id'];
    $file_size = $update['message']['video']['file_size'] ?? 0;
    $content_type = 'video';
} elseif (isset($update['message']['audio'])) {
    $file_id = $update['message']['audio']['file_id'];
    $file_size = $update['message']['audio']['file_size'] ?? 0;
    $content_type = 'audio';
} elseif (isset($update['message']['voice'])) {
    $file_id = $update['message']['voice']['file_id'];
    $file_size = $update['message']['voice']['file_size'] ?? 0;
    $content_type = 'voice';
} elseif (isset($update['message']['document'])) {
    $file_id = $update['message']['document']['file_id'];
    $file_size = $update['message']['document']['file_size'] ?? 0;
    $content_type = 'document';
}

$members = file_get_contents('members.txt');
$members_recent = file_get_contents('membersRecent.txt');
$groups_list = file_get_contents('groups.txt');
$current_step = file_get_contents('step.txt');
$lock_channel = trim(file_get_contents('lockChannel.txt')) == 'yes';
$bot_status = trim(file_get_contents('bot_status.txt'));

if ($user_id && strpos($members, "$user_id,") === false && $user_id != ADMIN_ID) {
    file_put_contents('members.txt', "$members$user_id,");
}

if ($chat_type && in_array($chat_type, ['group', 'supergroup']) && strpos($groups_list, "$chat_id,") === false) {
    file_put_contents('groups.txt', "$groups_list$chat_id,");
}

if ($user_id && $user_id != ADMIN_ID) {
    $members_recent = str_replace("$user_id,", '', $members_recent);
    file_put_contents('membersRecent.txt', "$user_id,$members_recent");
}

/* ==================== Ø¯Ø³ØªÙˆØ±Ø§Øª Ø¹Ù…ÙˆÙ…ÛŒ ==================== */
if ($message_text && preg_match('/^\/start$/i', trim($message_text))) {
    $welcome = trans('welcome', $user_id, $language_code);
    $welcome = str_replace('{name}', $full_name, $welcome);
   
    bot('sendMessage', [
        'chat_id' => $chat_id,
        'text' => $welcome,
        'parse_mode' => 'HTML'
    ]);
    exit();
}

if ($message_text && preg_match('/^\/help$/i', trim($message_text))) {
    showHelp($chat_id, $user_id, $language_code);
    exit();
}

if ($message_text && preg_match('/^\/language$/i', trim($message_text))) {
    $keyboard = json_encode([
        'inline_keyboard' => [
            [['text' => 'ğŸ‡®ğŸ‡· ÙØ§Ø±Ø³ÛŒ', 'callback_data' => 'setlang_fa']],
            [['text' => 'ğŸ‡ºğŸ‡¸ English', 'callback_data' => 'setlang_en']]
        ]
    ]);
   
    $lang_text = getUserLanguage($user_id, $language_code) == 'fa' ?
        'ğŸŒ Ø²Ø¨Ø§Ù† ÙØ¹Ù„ÛŒ: ÙØ§Ø±Ø³ÛŒ' : 'ğŸŒ Current language: English';
   
    bot('sendMessage', [
        'chat_id' => $chat_id,
        'text' => $lang_text . "\n\nÙ„Ø·ÙØ§ Ø²Ø¨Ø§Ù† Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ / Please choose your language:",
        'reply_markup' => $keyboard
    ]);
    exit();
}

if (isset($update['callback_query'])) {
    $callback_data = $update['callback_query']['data'];
    $callback_from = $update['callback_query']['from'];
    $callback_user_id = $callback_from['id'];
    $callback_message_id = $update['callback_query']['message']['message_id'];
   
    if (strpos($callback_data, 'setlang_') === 0) {
        $selected_lang = substr($callback_data, 8);
       
        $user_languages = file_get_contents('user_languages.txt');
        $languages = [];
       
        if (!empty($user_languages)) {
            $lines = explode(PHP_EOL, $user_languages);
            foreach ($lines as $line) {
                if (!empty($line)) {
                    $parts = explode(':', $line);
                    if (count($parts) >= 2) {
                        $id = $parts[0];
                        $lang = $parts[1];
                        $languages[$id] = $lang;
                    }
                }
            }
        }
       
        $languages[$callback_user_id] = $selected_lang;
       
        $new_user_languages = '';
        foreach ($languages as $id => $lang) {
            $new_user_languages .= "$id:$lang" . PHP_EOL;
        }
        file_put_contents('user_languages.txt', $new_user_languages);
       
        $success_text = $selected_lang == 'fa' ?
            'âœ… Ø²Ø¨Ø§Ù† Ø¨Ù‡ ÙØ§Ø±Ø³ÛŒ ØªØºÛŒÛŒØ± Ú©Ø±Ø¯' : 'âœ… Language changed to English';
       
        bot('answerCallbackQuery', [
            'callback_query_id' => $update['callback_query']['id'],
            'text' => $success_text
        ]);
       
        bot('editMessageText', [
            'chat_id' => $chat_id,
            'message_id' => $callback_message_id,
            'text' => $success_text
        ]);
    }
    exit();
}

/* ==================== Ø¯Ø³ØªÙˆØ±Ø§Øª Ù…Ø¯ÛŒØ±ÛŒØªÛŒ ==================== */
if ($user_id == ADMIN_ID) {
    if (preg_match('/^\/panel|^\/manage/i', trim($message_text))) {
        file_put_contents('step.txt', 'admin_mode');
       
        $admin_keyboard = json_encode([
            'keyboard' => [
                [['text' => 'ğŸ“Š Ø¢Ù…Ø§Ø± Ú©Ø§Ø±Ø¨Ø±Ø§Ù†'], ['text' => 'ğŸ” Ù‚ÙÙ„ Ú©Ø§Ù†Ø§Ù„']],
                [['text' => 'ğŸš€ Ø§Ø±Ø³Ø§Ù„ Ù‡Ù…Ú¯Ø§Ù†ÛŒ'], ['text' => 'ğŸ‘¥ Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ú¯Ø±ÙˆÙ‡â€ŒÙ‡Ø§']],
                [['text' => ($bot_status == 'on' ? 'ğŸ”´ Ø®Ø§Ù…ÙˆØ´ Ú©Ø±Ø¯Ù† Ø±Ø¨Ø§Øª' : 'ğŸŸ¢ Ø±ÙˆØ´Ù† Ú©Ø±Ø¯Ù† Ø±Ø¨Ø§Øª')]],
                [['text' => 'ğŸ”™ Ø®Ø±ÙˆØ¬ Ø§Ø² Ù…Ø¯ÛŒØ±ÛŒØª']]
            ],
            'resize_keyboard' => true
        ]);
       
        $panel_text = trans('admin_panel', $user_id, $language_code);
       
        bot('sendMessage', [
            'chat_id' => $chat_id,
            'text' => $panel_text,
            'parse_mode' => 'HTML',
            'reply_markup' => $admin_keyboard
        ]);
        exit();
    }
   
    if ($current_step === 'admin_mode') {
        if (trim($message_text) === 'ğŸ”´ Ø®Ø§Ù…ÙˆØ´ Ú©Ø±Ø¯Ù† Ø±Ø¨Ø§Øª' || trim($message_text) === 'ğŸŸ¢ Ø±ÙˆØ´Ù† Ú©Ø±Ø¯Ù† Ø±Ø¨Ø§Øª') {
            $new_status = $bot_status == 'on' ? 'off' : 'on';
            file_put_contents('bot_status.txt', $new_status);
           
            $status_text = trans('bot_status_changed', $user_id, $language_code);
            $status_text = str_replace('{status}', ($new_status == 'on' ? 'Ø±ÙˆØ´Ù†' : 'Ø®Ø§Ù…ÙˆØ´'), $status_text);
           
            bot('sendMessage', [
                'chat_id' => $chat_id,
                'text' => $status_text,
                'parse_mode' => 'HTML'
            ]);
            exit();
        } elseif ($message_text === 'ğŸ“Š Ø¢Ù…Ø§Ø± Ú©Ø§Ø±Ø¨Ø±Ø§Ù†') {
            $all_members = array_filter(explode(',', $members));
            $recent_members = array_filter(explode(',', $members_recent));
            $all_groups = array_filter(explode(',', $groups_list));
           
            $total_members = count($all_members);
            $total_groups = count($all_groups);
           
            $stats_text = trans('stats_message', $user_id, $language_code);
            $stats_text = str_replace(
                ['{users}', '{groups}', '{bot_status}'],
                [$total_members, $total_groups, ($bot_status == 'on' ? 'Ø±ÙˆØ´Ù† ğŸŸ¢' : 'Ø®Ø§Ù…ÙˆØ´ ğŸ”´')],
                $stats_text
            );
           
            bot('sendMessage', [
                'chat_id' => $chat_id,
                'text' => $stats_text,
                'parse_mode' => 'HTML'
            ]);
            exit();
        } elseif ($message_text === 'ğŸ” Ù‚ÙÙ„ Ú©Ø§Ù†Ø§Ù„') {
            $new_status = $lock_channel ? 'no' : 'yes';
            file_put_contents('lockChannel.txt', $new_status);
           
            $lock_text = trans('channel_lock_changed', $user_id, $language_code);
            $lock_text = str_replace('{status}', ($new_status == 'yes' ? 'ÙØ¹Ø§Ù„' : 'ØºÛŒØ±ÙØ¹Ø§Ù„'), $lock_text);
           
            bot('sendMessage', [
                'chat_id' => $chat_id,
                'text' => $lock_text,
                'parse_mode' => 'HTML'
            ]);
            exit();
        } elseif ($message_text === 'ğŸš€ Ø§Ø±Ø³Ø§Ù„ Ù‡Ù…Ú¯Ø§Ù†ÛŒ') {
            file_put_contents('step.txt', 'broadcast_users');
            bot('sendMessage', [
                'chat_id' => $chat_id,
                'text' => 'âœ‰ï¸ Ù„Ø·ÙØ§ Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ Ù‡Ù…Ú¯Ø§Ù†ÛŒ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:',
                'reply_markup' => json_encode([
                    'keyboard' => [[['text' => 'ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª']]],
                    'resize_keyboard' => true
                ])
            ]);
            exit();
        } elseif ($message_text === 'ğŸ‘¥ Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ú¯Ø±ÙˆÙ‡â€ŒÙ‡Ø§') {
            file_put_contents('step.txt', 'broadcast_groups');
            bot('sendMessage', [
                'chat_id' => $chat_id,
                'text' => 'ğŸ‘¥ Ù„Ø·ÙØ§ Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ú¯Ø±ÙˆÙ‡â€ŒÙ‡Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:',
                'reply_markup' => json_encode([
                    'keyboard' => [[['text' => 'ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª']]],
                    'resize_keyboard' => true
                ])
            ]);
            exit();
        } elseif ($message_text === 'ğŸ”™ Ø®Ø±ÙˆØ¬ Ø§Ø² Ù…Ø¯ÛŒØ±ÛŒØª') {
            file_put_contents('step.txt', 'none');
           
            $exit_text = trans('exit_admin', $user_id, $language_code);
           
            bot('sendMessage', [
                'chat_id' => $chat_id,
                'text' => $exit_text,
                'reply_markup' => json_encode(['remove_keyboard' => true]),
                'parse_mode' => 'HTML'
            ]);
            exit();
        } elseif ($message_text === 'ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª') {
            file_put_contents('step.txt', 'admin_mode');
            // Ø§Ø±Ø³Ø§Ù„ Ù…Ø¬Ø¯Ø¯ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª
            $admin_keyboard = json_encode([
                'keyboard' => [
                    [['text' => 'ğŸ“Š Ø¢Ù…Ø§Ø± Ú©Ø§Ø±Ø¨Ø±Ø§Ù†'], ['text' => 'ğŸ” Ù‚ÙÙ„ Ú©Ø§Ù†Ø§Ù„']],
                    [['text' => 'ğŸš€ Ø§Ø±Ø³Ø§Ù„ Ù‡Ù…Ú¯Ø§Ù†ÛŒ'], ['text' => 'ğŸ‘¥ Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ú¯Ø±ÙˆÙ‡â€ŒÙ‡Ø§']],
                    [['text' => ($bot_status == 'on' ? 'ğŸ”´ Ø®Ø§Ù…ÙˆØ´ Ú©Ø±Ø¯Ù† Ø±Ø¨Ø§Øª' : 'ğŸŸ¢ Ø±ÙˆØ´Ù† Ú©Ø±Ø¯Ù† Ø±Ø¨Ø§Øª')]],
                    [['text' => 'ğŸ”™ Ø®Ø±ÙˆØ¬ Ø§Ø² Ù…Ø¯ÛŒØ±ÛŒØª']]
                ],
                'resize_keyboard' => true
            ]);
           
            $panel_text = trans('admin_panel', $user_id, $language_code);
           
            bot('sendMessage', [
                'chat_id' => $chat_id,
                'text' => $panel_text,
                'parse_mode' => 'HTML',
                'reply_markup' => $admin_keyboard
            ]);
            exit();
        }
    }
   
    if ($current_step === 'broadcast_users') {
        if ($message_text && $message_text !== 'ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª') {
            $members_list = array_filter(explode(',', $members));
            $success = 0;
           
            foreach ($members_list as $member_id) {
                if (!empty($member_id)) {
                    $result = bot('sendMessage', [
                        'chat_id' => $member_id,
                        'text' => $message_text,
                        'parse_mode' => 'HTML'
                    ]);
                    if ($result && $result['ok']) {
                        $success++;
                    }
                    usleep(50000);
                }
            }
           
            file_put_contents('step.txt', 'admin_mode');
           
            $broadcast_text = trans('broadcast_sent', $user_id, $language_code);
            $broadcast_text = str_replace('{count}', $success, $broadcast_text);
           
            bot('sendMessage', [
                'chat_id' => $chat_id,
                'text' => $broadcast_text,
                'parse_mode' => 'HTML'
            ]);
            exit();
        } elseif ($message_text === 'ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª') {
            file_put_contents('step.txt', 'admin_mode');
            $admin_keyboard = json_encode([
                'keyboard' => [
                    [['text' => 'ğŸ“Š Ø¢Ù…Ø§Ø± Ú©Ø§Ø±Ø¨Ø±Ø§Ù†'], ['text' => 'ğŸ” Ù‚ÙÙ„ Ú©Ø§Ù†Ø§Ù„']],
                    [['text' => 'ğŸš€ Ø§Ø±Ø³Ø§Ù„ Ù‡Ù…Ú¯Ø§Ù†ÛŒ'], ['text' => 'ğŸ‘¥ Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ú¯Ø±ÙˆÙ‡â€ŒÙ‡Ø§']],
                    [['text' => ($bot_status == 'on' ? 'ğŸ”´ Ø®Ø§Ù…ÙˆØ´ Ú©Ø±Ø¯Ù† Ø±Ø¨Ø§Øª' : 'ğŸŸ¢ Ø±ÙˆØ´Ù† Ú©Ø±Ø¯Ù† Ø±Ø¨Ø§Øª')]],
                    [['text' => 'ğŸ”™ Ø®Ø±ÙˆØ¬ Ø§Ø² Ù…Ø¯ÛŒØ±ÛŒØª']]
                ],
                'resize_keyboard' => true
            ]);
           
            $panel_text = trans('admin_panel', $user_id, $language_code);
           
            bot('sendMessage', [
                'chat_id' => $chat_id,
                'text' => $panel_text,
                'parse_mode' => 'HTML',
                'reply_markup' => $admin_keyboard
            ]);
            exit();
        }
    }
   
    if ($current_step === 'broadcast_groups') {
        if ($message_text && $message_text !== 'ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª') {
            $groups_list = array_filter(explode(',', $groups_list));
            $success = 0;
           
            foreach ($groups_list as $group_id) {
                if (!empty($group_id)) {
                    $result = bot('sendMessage', [
                        'chat_id' => $group_id,
                        'text' => $message_text,
                        'parse_mode' => 'HTML'
                    ]);
                    if ($result && $result['ok']) {
                        $success++;
                    }
                    usleep(50000);
                }
            }
           
            file_put_contents('step.txt', 'admin_mode');
           
            $group_text = trans('group_broadcast_sent', $user_id, $language_code);
            $group_text = str_replace('{count}', $success, $group_text);
           
            bot('sendMessage', [
                'chat_id' => $chat_id,
                'text' => $group_text,
                'parse_mode' => 'HTML'
            ]);
            exit();
        } elseif ($message_text === 'ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª') {
            file_put_contents('step.txt', 'admin_mode');
            $admin_keyboard = json_encode([
                'keyboard' => [
                    [['text' => 'ğŸ“Š Ø¢Ù…Ø§Ø± Ú©Ø§Ø±Ø¨Ø±Ø§Ù†'], ['text' => 'ğŸ” Ù‚ÙÙ„ Ú©Ø§Ù†Ø§Ù„']],
                    [['text' => 'ğŸš€ Ø§Ø±Ø³Ø§Ù„ Ù‡Ù…Ú¯Ø§Ù†ÛŒ'], ['text' => 'ğŸ‘¥ Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ú¯Ø±ÙˆÙ‡â€ŒÙ‡Ø§']],
                    [['text' => ($bot_status == 'on' ? 'ğŸ”´ Ø®Ø§Ù…ÙˆØ´ Ú©Ø±Ø¯Ù† Ø±Ø¨Ø§Øª' : 'ğŸŸ¢ Ø±ÙˆØ´Ù† Ú©Ø±Ø¯Ù† Ø±Ø¨Ø§Øª')]],
                    [['text' => 'ğŸ”™ Ø®Ø±ÙˆØ¬ Ø§Ø² Ù…Ø¯ÛŒØ±ÛŒØª']]
                ],
                'resize_keyboard' => true
            ]);
           
            $panel_text = trans('admin_panel', $user_id, $language_code);
           
            bot('sendMessage', [
                'chat_id' => $chat_id,
                'text' => $panel_text,
                'parse_mode' => 'HTML',
                'reply_markup' => $admin_keyboard
            ]);
            exit();
        }
    }
}

/* ==================== Ø¨Ø±Ø±Ø³ÛŒ Ø¹Ø¶ÙˆÛŒØª Ø¯Ø± Ú©Ø§Ù†Ø§Ù„ ==================== */
function shouldCheckMembership($message_text, $caption, $chat_type) {
    // Ø¯Ø± Ú¯Ø±ÙˆÙ‡ ÙÙ‚Ø· ÙˆÙ‚ØªÛŒ Ú©Ù‡ Ú©Ø§Ø±Ø¨Ø± Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡Ø¯ Ø§Ø² Ø±Ø¨Ø§Øª Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†Ø¯ Ú†Ú© Ú©Ù†
    if ($chat_type == 'private') {
        return true;
    }
   
    if (!in_array($chat_type, ['group', 'supergroup'])) {
        return false;
    }
   
    // ÙÙ‚Ø· ÙˆÙ‚ØªÛŒ Ú©Ù‡ Ú©Ø§Ø±Ø¨Ø± Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡Ø¯ Ø§Ø² Ø±Ø¨Ø§Øª Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†Ø¯ Ú†Ú© Ú©Ù†
    if ($message_text && preg_match('/^\+/', trim($message_text))) {
        return true;
    }
   
    if ($caption && (preg_match('/^\+/', trim($caption)) || trim($caption) === '=')) {
        return true;
    }
   
    return false;
}

// Ø¨Ø±Ø±Ø³ÛŒ Ø¹Ø¶ÙˆÛŒØª Ø¯Ø± Ú©Ø§Ù†Ø§Ù„ - Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø¨Ø³ÛŒØ§Ø± Ù…Ù‡Ù… Ø§Ø³Øª
if ($lock_channel && $user_id && $user_id != ADMIN_ID && shouldCheckMembership($message_text, $caption, $chat_type)) {
    $is_member = isMember($user_id, CHANNEL);
    
    if (!$is_member) {
        $channel_text = trans('channel_required', $user_id, $language_code);
        $join_text = trans('join_channel', $user_id, $language_code);
       
        $channel_markup = json_encode([
            'inline_keyboard' => [
                [['text' => $join_text, 'url' => "https://t.me/" . CHANNEL]]
            ]
        ]);
       
        bot('sendMessage', [
            'chat_id' => $chat_id,
            'text' => $channel_text,
            'reply_markup' => $channel_markup,
            'parse_mode' => 'HTML',
            'reply_to_message_id' => $message_id
        ]);
        exit();
    }
}

/* ==================== Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø­Ø¬Ù… ÙØ§ÛŒÙ„ ==================== */
if ($file_size > MAX_FILE_SIZE) {
    $error_text = trans('file_too_large', $user_id, $language_code);
   
    bot('sendMessage', [
        'chat_id' => $chat_id,
        'text' => $error_text,
        'reply_to_message_id' => $message_id,
        'parse_mode' => 'HTML'
    ]);
    exit();
}

/* ==================== Ù¾Ø±Ø¯Ø§Ø²Ø´ ØªØµØ§ÙˆÛŒØ± QR Ú©Ø¯ ==================== */
if ($content_type === 'photo') {
    // Ø¯Ø± Ù¾ÛŒÙˆÛŒ Ù‡Ù…ÛŒØ´Ù‡ Ø³Ø¹ÛŒ Ú©Ù† QR Ú©Ø¯ Ø±Ùˆ Ø¨Ø®ÙˆÙ†ÛŒ
    if ($chat_type == 'private') {
        $qr_content = decodeQRCode($file_id);
       
        if ($qr_content) {
            $qr_text = trans('qr_content', $user_id, $language_code);
            $qr_text = str_replace('{content}', htmlspecialchars($qr_content), $qr_text);
           
            bot('sendMessage', [
                'chat_id' => $chat_id,
                'text' => $qr_text,
                'reply_to_message_id' => $message_id,
                'parse_mode' => 'HTML'
            ]);
            exit();
        }
        // Ø§Ú¯Ø± QR Ú©Ø¯ ØªØ´Ø®ÛŒØµ Ø¯Ø§Ø¯Ù‡ Ù†Ø´Ø¯ØŒ Ø¨Ù‡ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¹Ø§Ø¯ÛŒ Ø§Ø¯Ø§Ù…Ù‡ Ø¨Ø¯Ù‡
    }
   
    // Ø¯Ø± Ú¯Ø±ÙˆÙ‡ ÙÙ‚Ø· ÙˆÙ‚ØªÛŒ Ú©Ù‡ Ú©Ù¾Ø´Ù† = Ø¯Ø§Ø±Ù‡
    if ($chat_type != 'private' && $caption && trim($caption) === '=') {
        $qr_content = decodeQRCode($file_id);
       
        if ($qr_content) {
            $qr_text = trans('qr_content', $user_id, $language_code);
            $qr_text = str_replace('{content}', htmlspecialchars($qr_content), $qr_text);
           
            bot('sendMessage', [
                'chat_id' => $chat_id,
                'text' => $qr_text,
                'reply_to_message_id' => $message_id,
                'parse_mode' => 'HTML'
            ]);
        } else {
            $error_text = trans('qr_not_detected', $user_id, $language_code);
           
            bot('sendMessage', [
                'chat_id' => $chat_id,
                'text' => $error_text,
                'reply_to_message_id' => $message_id,
                'parse_mode' => 'HTML'
            ]);
        }
        exit();
    }
}

/* ==================== Ù¾Ø±Ø¯Ø§Ø²Ø´ Ú¯Ø±ÙˆÙ‡ÛŒ ==================== */
if (in_array($chat_type, ['group', 'supergroup'])) {
    $should_process = false;
    $content = null;
   
    if ($message_text && preg_match('/^\+/', trim($message_text))) {
        $should_process = true;
        $content = trim(substr(trim($message_text), 1));
    } elseif ($caption && preg_match('/^\+/', trim($caption))) {
        $should_process = true;
        $content = trim(substr(trim($caption), 1));
    }
   
    if ($should_process && $content) {
        sendQRCode($chat_id, $content, $message_id, false, $user_id, $language_code);
    }
    exit();
}

/* ==================== Ù¾Ø±Ø¯Ø§Ø²Ø´ Ú†Øª Ø®ØµÙˆØµÛŒ ==================== */
elseif ($chat_type == 'private') {
    if ($current_step !== 'admin_mode') {
        if ($message_text && !preg_match('/^\/(start|help|language|panel)/i', trim($message_text))) {
            sendQRCode($chat_id, $message_text, $message_id, true, $user_id, $language_code);
        } elseif ($content_type && $current_step !== 'admin_mode') {
            // ÙÙ‚Ø· Ù†ÙˆØ¹ Ù…Ø­ØªÙˆØ§ Ø±Ùˆ Ø°Ú©Ø± Ú©Ù†ØŒ Ù†Ù‡ Ù„ÛŒÙ†Ú© ÙØ§ÛŒÙ„
            $content_type_text = strtoupper($content_type);
            $content = "";
            
            if ($caption) {
                $content = $caption;
            } else {
                $content = "ÙØ§ÛŒÙ„ " . $content_type_text;
            }
           
            sendQRCode($chat_id, $content, $message_id, true, $user_id, $language_code);
        }
    }
    exit();
}
