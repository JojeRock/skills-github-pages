import { world, system } from '@minecraft/server';

console.log('§a[Distance Tracker] Loaded!');

// ذخیره اطلاعات ترک
const trackingData = new Map();

// برای تست در Single Player - لیست NPCها
const npcList = new Map();

// وقتی بازیکن دستور می‌دهد
world.beforeEvents.chatSend.subscribe((event) => {
    const message = event.message;
    const player = event.sender;
    
    // دستور /track
    if (message.startsWith('/track ')) {
        event.cancel = true;
        
        const targetName = message.split(' ')[1];
        
        // 1. اول بین بازیکنان واقعی جستجو کن
        const allPlayers = [...world.getPlayers()];
        let target = allPlayers.find(p => p.name.toLowerCase() === targetName.toLowerCase());
        
        // 2. اگر بازیکنی پیدا نشد، بین NPCها جستجو کن
        if (!target && npcList.has(targetName.toLowerCase())) {
            target = npcList.get(targetName.toLowerCase());
        }
        
        // 3. اگر NPC هم نبود، یک NPC جدید بساز
        if (!target) {
            player.sendMessage(`§eCreating NPC "${targetName}" for testing...`);
            
            try {
                // NPC رو با کامند summon ایجاد کن
                player.runCommand(`summon armor_stand "${targetName}" ~ ~ ~`);
                
                // صبر کن NPC ایجاد شه
                system.runTimeout(() => {
                    const entities = player.dimension.getEntities({
                        name: targetName,
                        type: "minecraft:armor_stand"
                    });
                    
                    if (entities.length > 0) {
                        const npc = entities[0];
                        npcList.set(targetName.toLowerCase(), npc);
                        
                        // شروع ترک NPC
                        trackingData.set(player.id, {
                            targetId: npc.id,
                            targetName: targetName,
                            startTime: Date.now(),
                            isNPC: true
                        });
                        
                        player.sendMessage(`§aNow tracking NPC: §e${targetName}§a!`);
                        player.sendMessage('§7Move the NPC with: §f/tp @e[name="' + targetName + '"] ~ ~ ~');
                        player.sendMessage('§7Type §f/cancel track §7to stop.');
                    }
                }, 10);
                
            } catch (e) {
                player.sendMessage('§cCould not create NPC. Make sure cheats are enabled!');
            }
            
            return;
        }
        
        if (player.id === target.id) {
            player.sendMessage('§cYou cannot track yourself!');
            return;
        }
        
        // ذخیره اطلاعات
        trackingData.set(player.id, {
            targetId: target.id,
            targetName: target.name || targetName,
            startTime: Date.now(),
            isNPC: target.typeId === 'minecraft:armor_stand'
        });
        
        player.sendMessage(`§aTracking §e${target.name || targetName}§a! Distance will appear below your coordinates.`);
        player.sendMessage('§7Type §f/cancel track §7to stop.');
    }
    
    // دستور /cancel track
    else if (message === '/cancel track') {
        event.cancel = true;
        
        if (trackingData.has(player.id)) {
            const data = trackingData.get(player.id);
            trackingData.delete(player.id);
            
            // پاک کردن HUD
            player.onScreenDisplay.setActionBar('');
            
            player.sendMessage(`§cStopped tracking §e${data.targetName}§c.`);
        } else {
            player.sendMessage('§cYou are not tracking anyone!');
        }
    }
    
    // دستور کمکی برای ساخت NPC
    else if (message.startsWith('/createnpc ')) {
        event.cancel = true;
        
        const npcName = message.split(' ')[1];
        player.runCommand(`summon armor_stand "${npcName}" ~ ~5 ~`);
        player.sendMessage(`§aNPC "${npcName}" created! Now use: §e/track ${npcName}`);
    }
    
    // دستور کمکی برای لیست NPCها
    else if (message === '/listnpcs') {
        event.cancel = true;
        
        if (npcList.size === 0) {
            player.sendMessage('§7No NPCs created yet. Use: §f/createnpc [name]');
        } else {
            player.sendMessage('§6Available NPCs:');
            for (const [name, npc] of npcList) {
                const pos = npc.location;
                player.sendMessage(`§7- §e${name} §8(X: ${Math.round(pos.x)}, Z: ${Math.round(pos.z)})`);
            }
            player.sendMessage('§7Track with: §f/track [name]');
        }
    }
    
    // دستور کمکی برای حذف NPC
    else if (message.startsWith('/removenpc ')) {
        event.cancel = true;
        
        const npcName = message.split(' ')[1];
        if (npcList.has(npcName.toLowerCase())) {
            const npc = npcList.get(npcName.toLowerCase());
            npc.triggerEvent('minecraft:despawn');
            npcList.delete(npcName.toLowerCase());
            player.sendMessage(`§cRemoved NPC: §e${npcName}`);
        } else {
            player.sendMessage(`§cNPC "${npcName}" not found!`);
        }
    }
});

// آپدیت HUD هر ثانیه
system.runInterval(() => {
    for (const [playerId, data] of trackingData) {
        const player = world.getPlayer(playerId);
        if (!player) {
            trackingData.delete(playerId);
            continue;
        }
        
        // پیدا کردن هدف
        let target;
        if (data.isNPC) {
            // اگر NPC هست، از لیست NPCها بگیر
            const entities = player.dimension.getEntities({ 
                type: "minecraft:armor_stand",
                name: data.targetName 
            });
            target = entities[0];
        } else {
            // اگر بازیکن واقعی هست
            target = world.getPlayer(data.targetId);
        }
        
        // اگر هدف وجود ندارد
        if (!target) {
            trackingData.delete(playerId);
            player.onScreenDisplay.setActionBar('');
            player.sendMessage(`§cTarget ${data.targetName} not found. Tracking stopped.`);
            continue;
        }
        
        // بررسی بعد (dimension) - فقط برای بازیکنان واقعی
        const playerDim = player.dimension.id;
        let targetDim = playerDim;
        
        if (!data.isNPC) {
            targetDim = target.dimension.id;
        }
        
        let displayText = '';
        
        if (playerDim !== targetDim && !data.isNPC) {
            // ابعاد مختلف (فقط برای بازیکنان واقعی)
            const dimName = getDimensionName(targetDim);
            displayText = `§7Tracking §e${data.targetName}§7: §5in ${dimName}`;
        } else {
            // ابعاد یکسان یا NPC - محاسبه فاصله
            const playerPos = player.location;
            const targetPos = target.location;
            
            // محاسبه فاصله X و Z (ارتفاع مهم نیست)
            const dx = targetPos.x - playerPos.x;
            const dz = targetPos.z - playerPos.z;
            const distance = Math.sqrt(dx * dx + dz * dz);
            
            // انتخاب رنگ بر اساس فاصله
            let color = '§a'; // سبز (دور)
            if (distance < 100) color = '§e'; // زرد
            if (distance < 50) color = '§6'; // نارنجی
            if (distance < 20) color = '§c'; // قرمز
            if (distance < 5) color = '§4'; // قرمز تیره
            
            displayText = `§7Tracking §e${data.targetName}§7: ${color}${Math.round(distance)} blocks`;
            
            // برای NPCها جهت هم نشان بده
            if (data.isNPC && distance > 5) {
                const direction = getDirection(playerPos, targetPos);
                displayText += ` §8${direction}`;
            }
        }
        
        // نمایش HUD
        player.onScreenDisplay.setActionBar(displayText);
    }
}, 20); // هر 1 ثانیه

// تابع کمکی برای نام بعد
function getDimensionName(dimensionId) {
    if (dimensionId === 'minecraft:overworld') return 'Overworld';
    if (dimensionId === 'minecraft:nether') return 'Nether';
    if (dimensionId === 'minecraft:the_end') return 'End';
    return dimensionId.replace('minecraft:', '');
}

// تابع کمکی برای جهت
function getDirection(pos1, pos2) {
    const dx = pos2.x - pos1.x;
    const dz = pos2.z - pos1.z;
    
    let angle = Math.atan2(dz, dx) * (180 / Math.PI);
    angle = (angle + 90 + 360) % 360;
    
    const directions = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'];
    const index = Math.round(angle / 45) % 8;
    
    return directions[index];
}

// تمیز کردن NPCهای مرده
system.runInterval(() => {
    for (const [name, npc] of npcList) {
        if (!npc.isValid()) {
            npcList.delete(name);
        }
    }
}, 100); // هر 5 ثانیه

// پیغام شروع
system.runTimeout(() => {
    world.sendMessage('§a[Distance Tracker] Type:');
    world.sendMessage('§7/track [name] §f- Start tracking');
    world.sendMessage('§7/createnpc [name] §f- Create NPC for testing');
    world.sendMessage('§7/listnpcs §f- List available NPCs');
    world.sendMessage('§7/cancel track §f- Stop tracking');
}, 60);
