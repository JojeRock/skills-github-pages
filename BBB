<?php
ini_set('display_errors', '1');
ini_set('display_startup_errors', '1');
error_reporting(E_ALL);

// ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ØµÙ„ÛŒ
define('BOT_TOKEN', '7735298785:AAEoKk3OtpUe_0YmYuGkS0k0hhOMGwZe2Vw');
define('ADMIN_ID', 5107034738);
define('MAX_LYRICS_LENGTH', 4000);
define('LOG_FILE', 'bot_logs.log');
define('DB_FILE', 'data/bot_db.json');
define('CACHE_DIR', 'data/cache');
define('CACHE_EXPIRE_TIME', 86400);

// Ø§ÛŒØ¬Ø§Ø¯ Ø³Ø§Ø®ØªØ§Ø± Ù¾ÙˆØ´Ù‡â€ŒÙ‡Ø§
if (!file_exists('data')) mkdir('data', 0755, true);
if (!file_exists(CACHE_DIR)) mkdir(CACHE_DIR, 0755, true);

// ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ
if (!function_exists('str_starts_with')) {
    function str_starts_with($haystack, $needle) {
        return substr($haystack, 0, strlen($needle)) === $needle;
    }
}

class LyricsBot {
    private $db;
    private $searchResults = [];
    
    public function __construct() {
        $this->initializeDatabase();
    }
    
    private function initializeDatabase() {
        if (!file_exists(DB_FILE)) {
            $this->db = [
                'users' => [],
                'stats' => [
                    'searches' => 0,
                    'cache_hits' => 0,
                    'users' => 0
                ]
            ];
            $this->saveDatabase();
        } else {
            $json = file_get_contents(DB_FILE);
            $this->db = json_decode($json, true) ?: ['users' => [], 'stats' => ['searches' => 0, 'cache_hits' => 0, 'users' => 0]];
        }
    }
    
    private function saveDatabase() {
        file_put_contents(DB_FILE, json_encode($this->db, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE));
    }
    
    private function sendTelegramRequest($method, $params = []) {
        $url = "https://api.telegram.org/bot" . BOT_TOKEN . "/" . $method;
        
        $ch = curl_init();
        curl_setopt($ch, CURLOPT_URL, $url);
        curl_setopt($ch, CURLOPT_POST, true);
        curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($params));
        curl_setopt($ch, CURLOPT_HTTPHEADER, ['Content-Type: application/json']);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
        curl_setopt($ch, CURLOPT_TIMEOUT, 10);
        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
        curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, false);
        
        $response = curl_exec($ch);
        curl_close($ch);
        
        return json_decode($response, true);
    }
    
    // ============ Ø³ÛŒØ³ØªÙ… Ø¬Ø³ØªØ¬ÙˆÛŒ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† ============
    private function searchLyrics($query) {
        $cacheKey = md5(strtolower($query));
        $cacheFile = CACHE_DIR . '/' . $cacheKey . '.json';
        
        // Ø¨Ø±Ø±Ø³ÛŒ Ú©Ø´
        if (file_exists($cacheFile)) {
            $cacheData = json_decode(file_get_contents($cacheFile), true);
            if ($cacheData && time() - $cacheData['timestamp'] < CACHE_EXPIRE_TIME) {
                $this->db['stats']['cache_hits']++;
                $this->saveDatabase();
                return $cacheData['results'];
            }
        }
        
        // Ø±ÙˆØ´ 1: Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø§ DuckDuckGo (Ø±Ø§ÛŒÚ¯Ø§Ù† Ùˆ Ø¨Ø¯ÙˆÙ† API)
        $results = $this->searchWithDuckDuckGo($query);
        
        // Ø±ÙˆØ´ 2: Ø§Ú¯Ø± DuckDuckGo Ú©Ø§Ø± Ù†Ú©Ø±Ø¯ØŒ Ø§Ø² API Ø±Ø§ÛŒÚ¯Ø§Ù† Ø¯ÛŒÚ¯Ø± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†
        if (!$results || count($results) < 3) {
            $results = $this->searchWithLyricsOVH($query);
        }
        
        // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Ú©Ø´
        if ($results) {
            $cacheData = ['timestamp' => time(), 'results' => $results];
            file_put_contents($cacheFile, json_encode($cacheData));
        }
        
        return $results;
    }
    
    private function searchWithDuckDuckGo($query) {
        $searchUrl = "https://html.duckduckgo.com/html/?q=" . urlencode($query . " lyrics genius.com");
        
        $ch = curl_init();
        curl_setopt_array($ch, [
            CURLOPT_URL => $searchUrl,
            CURLOPT_RETURNTRANSFER => true,
            CURLOPT_TIMEOUT => 15,
            CURLOPT_SSL_VERIFYPEER => false,
            CURLOPT_FOLLOWLOCATION => true,
            CURLOPT_USERAGENT => 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
            CURLOPT_HTTPHEADER => [
                'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',
                'Accept-Language: en-US,en;q=0.9'
            ]
        ]);
        
        $html = curl_exec($ch);
        curl_close($ch);
        
        if (!$html) return null;
        
        // Ù¾Ø§Ø±Ø³ Ú©Ø±Ø¯Ù† HTML
        $results = [];
        
        // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ÛŒ Genius
        if (preg_match_all('/<a[^>]*class="result__url"[^>]*href="([^"]*genius\.com[^"]*)"[^>]*>.*?<a[^>]*class="result__title"[^>]*>(.*?)<\/a>/is', $html, $matches, PREG_SET_ORDER)) {
            foreach ($matches as $index => $match) {
                if ($index >= 5) break;
                
                $url = $match[1];
                $title = strip_tags($match[2]);
                
                // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù‡Ù†Ø±Ù…Ù†Ø¯ Ùˆ Ø¢Ù‡Ù†Ú¯ Ø§Ø² Ø¹Ù†ÙˆØ§Ù†
                $artist = 'Unknown Artist';
                $songTitle = $title;
                
                if (preg_match('/(.+?)\s*[â€“\-]\s*(.+?)(?:\s*\||\s*Lyrics|$)/i', $title, $titleMatches)) {
                    $artist = trim($titleMatches[1]);
                    $songTitle = trim($titleMatches[2]);
                }
                
                $results[] = [
                    'id' => 'ddg_' . $index,
                    'title' => $songTitle,
                    'artist' => $artist,
                    'url' => $url,
                    'source' => 'genius'
                ];
            }
        }
        
        return $results;
    }
    
    private function searchWithLyricsOVH($query) {
        // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Lyrics.ovh API Ú©Ù‡ Ø±Ø§ÛŒÚ¯Ø§Ù† Ù‡Ø³Øª
        $url = "https://api.lyrics.ovh/suggest/" . urlencode($query);
        
        $ch = curl_init();
        curl_setopt_array($ch, [
            CURLOPT_URL => $url,
            CURLOPT_RETURNTRANSFER => true,
            CURLOPT_TIMEOUT => 15,
            CURLOPT_SSL_VERIFYPEER => false,
            CURLOPT_USERAGENT => 'Mozilla/5.0'
        ]);
        
        $response = curl_exec($ch);
        curl_close($ch);
        
        $data = json_decode($response, true);
        
        if (!$data || !isset($data['data'])) {
            return null;
        }
        
        $results = [];
        foreach (array_slice($data['data'], 0, 5) as $index => $item) {
            $results[] = [
                'id' => 'ovh_' . $index,
                'title' => $item['title'] ?? 'Unknown',
                'artist' => $item['artist']['name'] ?? 'Unknown Artist',
                'url' => '',
                'source' => 'lyrics_ovh'
            ];
        }
        
        return $results;
    }
    
    private function getLyrics($songId, $artist, $title, $source) {
        $cacheKey = md5($artist . '_' . $title);
        $cacheFile = CACHE_DIR . '/lyrics_' . $cacheKey . '.json';
        
        // Ø¨Ø±Ø±Ø³ÛŒ Ú©Ø´
        if (file_exists($cacheFile)) {
            $cacheData = json_decode(file_get_contents($cacheFile), true);
            if ($cacheData && time() - $cacheData['timestamp'] < CACHE_EXPIRE_TIME) {
                $this->db['stats']['cache_hits']++;
                $this->saveDatabase();
                return $cacheData['lyrics'];
            }
        }
        
        // Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…Ù†Ø¨Ø¹ØŒ Ø±ÙˆØ´ Ø¯Ø±ÛŒØ§ÙØª Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†
        if ($source === 'genius') {
            $lyrics = $this->getGeniusLyrics($artist, $title);
        } else {
            $lyrics = $this->getLyricsOVHLyrics($artist, $title);
        }
        
        // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Ú©Ø´
        if ($lyrics) {
            $cacheData = ['timestamp' => time(), 'lyrics' => $lyrics];
            file_put_contents($cacheFile, json_encode($cacheData));
        }
        
        return $lyrics;
    }
    
    private function getGeniusLyrics($artist, $title) {
        // Ø±ÙˆØ´ 1: Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± DuckDuckGo Ø¨Ø±Ø§ÛŒ Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ù„ÛŒÙ†Ú©
        $searchUrl = "https://html.duckduckgo.com/html/?q=" . urlencode("$artist $title lyrics genius.com");
        
        $ch = curl_init();
        curl_setopt_array($ch, [
            CURLOPT_URL => $searchUrl,
            CURLOPT_RETURNTRANSFER => true,
            CURLOPT_TIMEOUT => 15,
            CURLOPT_SSL_VERIFYPEER => false,
            CURLOPT_USERAGENT => 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
        ]);
        
        $html = curl_exec($ch);
        curl_close($ch);
        
        if (!$html) return null;
        
        // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø§ÙˆÙ„ÛŒÙ† Ù„ÛŒÙ†Ú© Genius
        if (preg_match('/<a[^>]*href="(https?:\/\/genius\.com\/[^"]*)"[^>]*>/i', $html, $matches)) {
            $geniusUrl = $matches[1];
            
            // Ø­Ø§Ù„Ø§ Ù…ØªÙ† Ø±Ø§ Ø§Ø² Genius Ø¨Ú¯ÛŒØ±
            return $this->scrapeGeniusPage($geniusUrl);
        }
        
        return null;
    }
    
    private function scrapeGeniusPage($url) {
        // Ù¾Ø±ÙˆÚ©Ø³ÛŒâ€ŒÙ‡Ø§ÛŒ Ø±Ø§ÛŒÚ¯Ø§Ù†
        $proxies = [
            'https://api.allorigins.win/raw?url=',
            'https://corsproxy.io/?',
            'https://api.codetabs.com/v1/proxy?quest='
        ];
        
        foreach ($proxies as $proxy) {
            $proxyUrl = $proxy . urlencode($url);
            
            $ch = curl_init();
            curl_setopt_array($ch, [
                CURLOPT_URL => $proxyUrl,
                CURLOPT_RETURNTRANSFER => true,
                CURLOPT_TIMEOUT => 20,
                CURLOPT_SSL_VERIFYPEER => false,
                CURLOPT_USERAGENT => 'Mozilla/5.0'
            ]);
            
            $html = curl_exec($ch);
            curl_close($ch);
            
            if (!$html) continue;
            
            // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…ØªÙ†
            if (preg_match('/<div[^>]*class="[^"]*lyrics[^"]*"[^>]*>(.*?)<\/div>/is', $html, $matches)) {
                $lyrics = strip_tags($matches[1]);
                $lyrics = preg_replace('/\[.*?\]\s*/', '', $lyrics);
                $lyrics = trim($lyrics);
                
                if (strlen($lyrics) > 100) {
                    return $lyrics;
                }
            }
        }
        
        return null;
    }
    
    private function getLyricsOVHLyrics($artist, $title) {
        $url = "https://api.lyrics.ovh/v1/" . urlencode($artist) . "/" . urlencode($title);
        
        $ch = curl_init();
        curl_setopt_array($ch, [
            CURLOPT_URL => $url,
            CURLOPT_RETURNTRANSFER => true,
            CURLOPT_TIMEOUT => 15,
            CURLOPT_SSL_VERIFYPEER => false
        ]);
        
        $response = curl_exec($ch);
        curl_close($ch);
        
        $data = json_decode($response, true);
        
        return $data['lyrics'] ?? null;
    }
    
    // ============ Ø±Ø§Ø¨Ø· Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø³Ø§Ø¯Ù‡ ============
    public function handleStart($chatId, $userId, $firstName) {
        $this->registerUser($userId, $firstName);
        
        $message = "ğŸµ *Ø¨Ù‡ Ø±Ø¨Ø§Øª Ø¬Ø³ØªØ¬ÙˆÛŒ Ù…ØªÙ† Ø¢Ù‡Ù†Ú¯ Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯!*\n\n";
        $message .= "Ù…Ù† Ù…ÛŒâ€ŒØªÙˆÙ†Ù… Ù…ØªÙ† Ø¢Ù‡Ù†Ú¯â€ŒÙ‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù Ø±Ùˆ Ø¨Ø±Ø§Øª Ù¾ÛŒØ¯Ø§ Ú©Ù†Ù….\n\n";
        $message .= "âœ¨ *Ø¯Ø³ØªÙˆØ±Ø§Øª:*\n";
        $message .= "â€¢ /search [Ù†Ø§Ù… Ø¢Ù‡Ù†Ú¯] - Ø¬Ø³ØªØ¬ÙˆÛŒ Ø¢Ù‡Ù†Ú¯\n";
        $message .= "â€¢ /help - Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡\n";
        $message .= "â€¢ /stats - Ø¢Ù…Ø§Ø± Ø±Ø¨Ø§Øª\n\n";
        $message .= "ğŸ“ *Ù…Ø«Ø§Ù„:*\n";
        $message .= "`/search Shape of You`\n";
        $message .= "`/search Ø¨ÛŒâ€ŒØ¨ÛŒ Ù¾Ø±Ø³Ù¾ÙˆÙ„ÛŒØ³`";
        
        $this->sendTelegramRequest('sendMessage', [
            'chat_id' => $chatId,
            'text' => $message,
            'parse_mode' => 'Markdown',
            'reply_markup' => json_encode([
                'inline_keyboard' => [
                    [['text' => 'ğŸ” Ø¬Ø³ØªØ¬ÙˆÛŒ Ø¢Ù‡Ù†Ú¯', 'callback_data' => 'search']],
                    [['text' => 'ğŸ“Š Ø¢Ù…Ø§Ø± Ø±Ø¨Ø§Øª', 'callback_data' => 'stats']],
                    [['text' => 'â„¹ï¸ Ø±Ø§Ù‡Ù†Ù…Ø§', 'callback_data' => 'help']]
                ]
            ])
        ]);
    }
    
    private function registerUser($userId, $firstName) {
        if (!isset($this->db['users'][$userId])) {
            $this->db['users'][$userId] = [
                'name' => $firstName,
                'first_seen' => date('Y-m-d H:i:s'),
                'search_count' => 0
            ];
            $this->db['stats']['users'] = count($this->db['users']);
            $this->saveDatabase();
        }
    }
    
    public function handleSearch($chatId, $userId, $query) {
        if (empty($query)) {
            $this->sendTelegramRequest('sendMessage', [
                'chat_id' => $chatId,
                'text' => "âš ï¸ Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ø¢Ù‡Ù†Ú¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.\nÙ…Ø«Ø§Ù„: `/search Shape of You`",
                'parse_mode' => 'Markdown'
            ]);
            return;
        }
        
        // Ø§ÙØ²Ø§ÛŒØ´ Ø¢Ù…Ø§Ø±
        $this->db['stats']['searches']++;
        $this->db['users'][$userId]['search_count'] = ($this->db['users'][$userId]['search_count'] ?? 0) + 1;
        $this->saveDatabase();
        
        $this->sendTelegramRequest('sendMessage', [
            'chat_id' => $chatId,
            'text' => "ğŸ” *Ø¯Ø± Ø­Ø§Ù„ Ø¬Ø³ØªØ¬Ùˆ:*\n`$query`\n\nÙ„Ø·ÙØ§Ù‹ ØµØ¨Ø± Ú©Ù†ÛŒØ¯...",
            'parse_mode' => 'Markdown'
        ]);
        
        $results = $this->searchLyrics($query);
        
        if (!$results || count($results) === 0) {
            $this->sendTelegramRequest('sendMessage', [
                'chat_id' => $chatId,
                'text' => "âŒ *Ù†ØªÛŒØ¬Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯!*\n\nÙ„Ø·ÙØ§Ù‹:\nâ€¢ Ù†Ø§Ù… Ø¯Ù‚ÛŒÙ‚â€ŒØªØ± Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯\nâ€¢ ÛŒØ§ Ø¢Ù‡Ù†Ú¯ Ø¯ÛŒÚ¯Ø±ÛŒ Ø¬Ø³ØªØ¬Ùˆ Ú©Ù†ÛŒØ¯",
                'parse_mode' => 'Markdown',
                'reply_markup' => json_encode([
                    'inline_keyboard' => [
                        [['text' => 'ğŸ” Ø¬Ø³ØªØ¬ÙˆÛŒ Ø¬Ø¯ÛŒØ¯', 'callback_data' => 'search']],
                        [['text' => 'ğŸ  Ù…Ù†Ùˆ', 'callback_data' => 'menu']]
                    ]
                ])
            ]);
            return;
        }
        
        // Ø°Ø®ÛŒØ±Ù‡ Ù†ØªØ§ÛŒØ¬ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±
        $this->searchResults[$userId] = $results;
        
        // Ù†Ù…Ø§ÛŒØ´ Ù†ØªØ§ÛŒØ¬
        $text = "âœ… *" . count($results) . " Ù†ØªÛŒØ¬Ù‡ Ù¾ÛŒØ¯Ø§ Ø´Ø¯:*\n\n";
        
        $keyboard = [];
        
        foreach ($results as $index => $result) {
            $text .= ($index + 1) . ". *" . $result['artist'] . "* - " . $result['title'] . "\n";
            
            $keyboard[] = [[
                'text' => ($index + 1) . ". Ø§Ù†ØªØ®Ø§Ø¨",
                'callback_data' => 'select_' . $index
            ]];
        }
        
        $keyboard[] = [
            ['text' => 'ğŸ” Ø¬Ø³ØªØ¬ÙˆÛŒ Ø¬Ø¯ÛŒØ¯', 'callback_data' => 'search'],
            ['text' => 'ğŸ  Ù…Ù†Ùˆ', 'callback_data' => 'menu']
        ];
        
        $this->sendTelegramRequest('sendMessage', [
            'chat_id' => $chatId,
            'text' => $text,
            'parse_mode' => 'Markdown',
            'reply_markup' => json_encode(['inline_keyboard' => $keyboard])
        ]);
    }
    
    public function handleSongSelection($chatId, $userId, $songIndex) {
        if (!isset($this->searchResults[$userId][$songIndex])) {
            $this->sendTelegramRequest('sendMessage', [
                'chat_id' => $chatId,
                'text' => "âŒ Ø¢Ù‡Ù†Ú¯ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯."
            ]);
            return;
        }
        
        $song = $this->searchResults[$userId][$songIndex];
        
        $this->sendTelegramRequest('sendMessage', [
            'chat_id' => $chatId,
            'text' => "ğŸ“¥ *Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ù…ØªÙ†...*\n\nğŸµ *" . $song['artist'] . "*\nğŸ¶ *" . $song['title'] . "*",
            'parse_mode' => 'Markdown'
        ]);
        
        // Ø¯Ø±ÛŒØ§ÙØª Ù…ØªÙ† Ø¢Ù‡Ù†Ú¯
        $lyrics = $this->getLyrics($song['id'], $song['artist'], $song['title'], $song['source'] ?? 'genius');
        
        if (!$lyrics) {
            $this->sendTelegramRequest('sendMessage', [
                'chat_id' => $chatId,
                'text' => "âŒ *Ù…ØªÙ† Ø¢Ù‡Ù†Ú¯ ÛŒØ§ÙØª Ù†Ø´Ø¯!*\n\nÙ…ØªØ£Ø³ÙØ§Ù†Ù‡ Ù†ØªÙˆØ§Ù†Ø³ØªÙ… Ù…ØªÙ† Ø§ÛŒÙ† Ø¢Ù‡Ù†Ú¯ Ø±Ø§ Ù¾ÛŒØ¯Ø§ Ú©Ù†Ù….\nÙ„Ø·ÙØ§Ù‹ Ø¢Ù‡Ù†Ú¯ Ø¯ÛŒÚ¯Ø±ÛŒ Ø±Ø§ Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†ÛŒØ¯.",
                'parse_mode' => 'Markdown',
                'reply_markup' => json_encode([
                    'inline_keyboard' => [
                        [['text' => 'ğŸ” Ø¬Ø³ØªØ¬ÙˆÛŒ Ø¬Ø¯ÛŒØ¯', 'callback_data' => 'search']],
                        [['text' => 'ğŸ  Ù…Ù†Ùˆ', 'callback_data' => 'menu']]
                    ]
                ])
            ]);
            return;
        }
        
        // Ø§Ø±Ø³Ø§Ù„ Ù…ØªÙ† Ø¢Ù‡Ù†Ú¯
        $this->sendLyrics($chatId, $song, $lyrics);
    }
    
    private function sendLyrics($chatId, $song, $lyrics) {
        $header = "ğŸµ *" . $song['artist'] . " - " . $song['title'] . "*\n\n";
        
        // ØªÙ‚Ø³ÛŒÙ… Ù…ØªÙ† Ø§Ú¯Ø± Ø·ÙˆÙ„Ø§Ù†ÛŒ Ø¨Ø§Ø´Ø¯
        if (strlen($lyrics) > 3000) {
            $parts = str_split($lyrics, 3000);
        } else {
            $parts = [$lyrics];
        }
        
        // Ø§Ø±Ø³Ø§Ù„ Ù‚Ø³Ù…Øªâ€ŒÙ‡Ø§
        foreach ($parts as $index => $part) {
            $text = ($index === 0 ? $header : '') . $part;
            
            $replyMarkup = null;
            if ($index === count($parts) - 1) {
                $replyMarkup = [
                    'inline_keyboard' => [
                        [['text' => 'ğŸ” Ø¬Ø³ØªØ¬ÙˆÛŒ Ø¬Ø¯ÛŒØ¯', 'callback_data' => 'search']],
                        [['text' => 'ğŸ  Ù…Ù†Ùˆ', 'callback_data' => 'menu']]
                    ]
                ];
            }
            
            $this->sendTelegramRequest('sendMessage', [
                'chat_id' => $chatId,
                'text' => $text,
                'parse_mode' => 'Markdown',
                'reply_markup' => $replyMarkup ? json_encode($replyMarkup) : null
            ]);
            
            usleep(500000); // Ù†ÛŒÙ… Ø«Ø§Ù†ÛŒÙ‡ ØªØ§Ø®ÛŒØ±
        }
    }
    
    public function handleStats($chatId) {
        $stats = $this->db['stats'];
        $totalUsers = count($this->db['users']);
        
        $text = "ğŸ“Š *Ø¢Ù…Ø§Ø± Ø±Ø¨Ø§Øª*\n\n";
        $text .= "ğŸ‘¥ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ú©Ù„: *" . number_format($totalUsers) . "*\n";
        $text .= "ğŸ” Ø¬Ø³ØªØ¬ÙˆÙ‡Ø§: *" . number_format($stats['searches']) . "*\n";
        $text .= "ğŸ’¾ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ú©Ø´: *" . number_format($stats['cache_hits']) . "*\n";
        $text .= "ğŸ“… ØªØ§Ø±ÛŒØ®: *" . date('Y-m-d H:i:s') . "*";
        
        $this->sendTelegramRequest('sendMessage', [
            'chat_id' => $chatId,
            'text' => $text,
            'parse_mode' => 'Markdown',
            'reply_markup' => json_encode([
                'inline_keyboard' => [
                    [['text' => 'ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª', 'callback_data' => 'menu']]
                ]
            ])
        ]);
    }
    
    public function handleHelp($chatId) {
        $text = "â„¹ï¸ *Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø±Ø¨Ø§Øª*\n\n";
        $text .= "ğŸµ *Ø¯Ø³ØªÙˆØ±Ø§Øª Ø§ØµÙ„ÛŒ:*\n";
        $text .= "â€¢ /search [Ù†Ø§Ù… Ø¢Ù‡Ù†Ú¯] - Ø¬Ø³ØªØ¬ÙˆÛŒ Ø¢Ù‡Ù†Ú¯\n";
        $text .= "â€¢ /stats - Ù†Ù…Ø§ÛŒØ´ Ø¢Ù…Ø§Ø±\n";
        $text .= "â€¢ /help - Ø§ÛŒÙ† Ø±Ø§Ù‡Ù†Ù…Ø§\n\n";
        
        $text .= "ğŸ’¡ *Ù†Ú©Ø§Øª:*\n";
        $text .= "â€¢ Ù†Ø§Ù… Ø¢Ù‡Ù†Ú¯ Ø±Ø§ Ø¨Ù‡ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ ÛŒØ§ ÙØ§Ø±Ø³ÛŒ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯\n";
        $text .= "â€¢ Ø¨Ø±Ø§ÛŒ Ù†ØªØ§ÛŒØ¬ Ø¨Ù‡ØªØ±ØŒ Ù†Ø§Ù… Ú©Ø§Ù…Ù„ Ø¢Ù‡Ù†Ú¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯\n";
        $text .= "â€¢ Ø±Ø¨Ø§Øª Ø§Ø² Ú†Ù†Ø¯ÛŒÙ† Ù…Ù†Ø¨Ø¹ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†Ø¯\n\n";
        
        $text .= "âš¡ *Ù…Ø«Ø§Ù„â€ŒÙ‡Ø§:*\n";
        $text .= "`/search Shape of You`\n";
        $text .= "`/search Ø¨ÛŒâ€ŒØ¨ÛŒ Ù¾Ø±Ø³Ù¾ÙˆÙ„ÛŒØ³`\n";
        $text .= "`/search Ed Sheeran Perfect`";
        
        $this->sendTelegramRequest('sendMessage', [
            'chat_id' => $chatId,
            'text' => $text,
            'parse_mode' => 'Markdown',
            'reply_markup' => json_encode([
                'inline_keyboard' => [
                    [['text' => 'ğŸ” Ø´Ø±ÙˆØ¹ Ø¬Ø³ØªØ¬Ùˆ', 'callback_data' => 'search']],
                    [['text' => 'ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª', 'callback_data' => 'menu']]
                ]
            ])
        ]);
    }
    
    public function handleMenu($chatId, $userId) {
        $this->handleStart($chatId, $userId, 'Ú©Ø§Ø±Ø¨Ø±');
    }
    
    // Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø§ØµÙ„ÛŒ
    public function processUpdate($update) {
        if (isset($update['message'])) {
            $message = $update['message'];
            $chatId = $message['chat']['id'];
            $userId = $message['from']['id'];
            $text = $message['text'] ?? '';
            
            if (strpos($text, '/start') === 0) {
                $firstName = $message['from']['first_name'] ?? 'Ú©Ø§Ø±Ø¨Ø±';
                $this->handleStart($chatId, $userId, $firstName);
            } elseif (strpos($text, '/search') === 0) {
                $query = trim(str_replace('/search', '', $text));
                $this->handleSearch($chatId, $userId, $query);
            } elseif (strpos($text, '/stats') === 0) {
                $this->handleStats($chatId);
            } elseif (strpos($text, '/help') === 0) {
                $this->handleHelp($chatId);
            } elseif (strlen($text) > 2) {
                // Ø§Ú¯Ø± Ù¾ÛŒØ§Ù… Ù…Ø¹Ù…ÙˆÙ„ÛŒ Ø§Ø³ØªØŒ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ù†Ø¸Ø± Ø¨Ú¯ÛŒØ±
                $this->handleSearch($chatId, $userId, $text);
            }
        } elseif (isset($update['callback_query'])) {
            $callback = $update['callback_query'];
            $chatId = $callback['message']['chat']['id'];
            $userId = $callback['from']['id'];
            $data = $callback['data'];
            
            if ($data === 'menu') {
                $this->handleMenu($chatId, $userId);
            } elseif ($data === 'search') {
                $this->sendTelegramRequest('sendMessage', [
                    'chat_id' => $chatId,
                    'text' => "ğŸ” Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ø¢Ù‡Ù†Ú¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯:\n(Ù…Ø«Ù„Ø§Ù‹: Shape of You ÛŒØ§ Ø¨ÛŒâ€ŒØ¨ÛŒ Ù¾Ø±Ø³Ù¾ÙˆÙ„ÛŒØ³)",
                    'parse_mode' => 'Markdown'
                ]);
            } elseif ($data === 'stats') {
                $this->handleStats($chatId);
            } elseif ($data === 'help') {
                $this->handleHelp($chatId);
            } elseif (strpos($data, 'select_') === 0) {
                $index = intval(str_replace('select_', '', $data));
                $this->handleSongSelection($chatId, $userId, $index);
            }
            
            // Ù¾Ø§Ø³Ø® Ø¨Ù‡ callback
            $this->sendTelegramRequest('answerCallbackQuery', [
                'callback_query_id' => $callback['id']
            ]);
        }
    }
}

// Ø§Ø¬Ø±Ø§ÛŒ Ø±Ø¨Ø§Øª
$bot = new LyricsBot();
$update = json_decode(file_get_contents('php://input'), true);

if ($update) {
    $bot->processUpdate($update);
} else {
    // ØµÙØ­Ù‡ ØªØ³Øª
    echo "<!DOCTYPE html>
    <html lang='fa' dir='rtl'>
    <head>
        <meta charset='UTF-8'>
        <meta name='viewport' content='width=device-width, initial-scale=1.0'>
        <title>ğŸµ Ø±Ø¨Ø§Øª Ø¬Ø³ØªØ¬ÙˆÛŒ Ù…ØªÙ† Ø¢Ù‡Ù†Ú¯</title>
        <style>
            body {
                font-family: 'Vazir', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                max-width: 800px;
                margin: 0 auto;
                padding: 20px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                color: white;
                direction: rtl;
            }
            .container {
                background: rgba(255, 255, 255, 0.1);
                backdrop-filter: blur(10px);
                border-radius: 20px;
                padding: 40px;
                margin-top: 50px;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            }
            h1 {
                text-align: center;
                margin-bottom: 30px;
                font-size: 2.5em;
            }
            .status {
                background: rgba(255, 255, 255, 0.2);
                border-radius: 10px;
                padding: 20px;
                margin: 20px 0;
            }
            .status-item {
                display: flex;
                justify-content: space-between;
                margin: 10px 0;
                padding: 10px;
                background: rgba(255, 255, 255, 0.1);
                border-radius: 5px;
            }
            .success { color: #4ade80; }
            .test-btn {
                display: block;
                width: 100%;
                padding: 15px;
                background: #4f46e5;
                color: white;
                border: none;
                border-radius: 10px;
                font-size: 18px;
                cursor: pointer;
                margin-top: 20px;
                font-family: inherit;
            }
            .test-btn:hover { background: #4338ca; }
            .result {
                margin-top: 20px;
                padding: 20px;
                background: rgba(255, 255, 255, 0.1);
                border-radius: 10px;
                display: none;
            }
            .instructions {
                margin-top: 30px;
                padding: 20px;
                background: rgba(255, 255, 255, 0.15);
                border-radius: 10px;
            }
        </style>
        <link href='https://cdn.jsdelivr.net/gh/rastikerdar/vazir-font@v30.1.0/dist/font-face.css' rel='stylesheet'>
    </head>
    <body>
        <div class='container'>
            <h1>ğŸµ Ø±Ø¨Ø§Øª Ø¬Ø³ØªØ¬ÙˆÛŒ Ù…ØªÙ† Ø¢Ù‡Ù†Ú¯</h1>
            
            <div class='status'>
                <div class='status-item'>
                    <span>Ø±Ø¨Ø§Øª ØªÙ„Ú¯Ø±Ø§Ù…:</span>
                    <span class='success'>âœ… ÙØ¹Ø§Ù„</span>
                </div>
                <div class='status-item'>
                    <span>Ø³ÛŒØ³ØªÙ… Ø¬Ø³ØªØ¬Ùˆ:</span>
                    <span class='success'>âœ… DuckDuckGo + Lyrics.ovh</span>
                </div>
                <div class='status-item'>
                    <span>Ø³ÛŒØ³ØªÙ… Ú©Ø´:</span>
                    <span class='success'>âœ… ÙØ¹Ø§Ù„</span>
                </div>
                <div class='status-item'>
                    <span>Ù¾ÙˆØ´Ù‡ Ø¯Ø§Ø¯Ù‡:</span>
                    <span class='success'>âœ… Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯Ù‡</span>
                </div>
            </div>
            
            <button class='test-btn' onclick='testSearch()'>ğŸ” ØªØ³Øª Ø¬Ø³ØªØ¬Ùˆ (Shape of You)</button>
            
            <div class='result' id='testResult'></div>
            
            <div class='instructions'>
                <h3>ğŸ“‹ Ø¯Ø³ØªÙˆØ±Ø§Ù„Ø¹Ù…Ù„:</h3>
                <p>1. ÙØ§ÛŒÙ„ Ø±Ø§ Ø±ÙˆÛŒ Ù‡Ø§Ø³Øª Ø¢Ù¾Ù„ÙˆØ¯ Ú©Ù†ÛŒØ¯</p>
                <p>2. Ø¯Ø± ØªÙ„Ú¯Ø±Ø§Ù… Ø¨Ù‡ Ø±Ø¨Ø§Øª Ù…Ø±Ø§Ø¬Ø¹Ù‡ Ú©Ù†ÛŒØ¯</p>
                <p>3. Ø¯Ø³ØªÙˆØ±Ø§Øª Ø²ÛŒØ± Ø±Ø§ Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†ÛŒØ¯:</p>
                <ul>
                    <li><code>/start</code> - Ø´Ø±ÙˆØ¹ Ø±Ø¨Ø§Øª</li>
                    <li><code>/search Shape of You</code> - Ø¬Ø³ØªØ¬ÙˆÛŒ Ø¢Ù‡Ù†Ú¯</li>
                    <li><code>/search Ø¨ÛŒâ€ŒØ¨ÛŒ Ù¾Ø±Ø³Ù¾ÙˆÙ„ÛŒØ³</code> - Ø¬Ø³ØªØ¬ÙˆÛŒ ÙØ§Ø±Ø³ÛŒ</li>
                </ul>
                <p>âœ… Ø§ÛŒÙ† Ø±Ø¨Ø§Øª Ø¨Ø¯ÙˆÙ† Ù†ÛŒØ§Ø² Ø¨Ù‡ API Key Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯!</p>
            </div>
        </div>
        
        <script>
        function testSearch() {
            const resultDiv = document.getElementById('testResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = 'ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ ØªØ³Øª Ø¬Ø³ØªØ¬Ùˆ...';
            
            fetch('?test=shape')
                .then(response => response.text())
                .then(data => {
                    resultDiv.innerHTML = data;
                })
                .catch(error => {
                    resultDiv.innerHTML = 'âŒ Ø®Ø·Ø§ Ø¯Ø± ØªØ³Øª: ' + error;
                });
        }
        </script>
    </body>
    </html>";
    
    // ØªØ³Øª Ø¬Ø³ØªØ¬Ùˆ
    if (isset($_GET['test'])) {
        $testQuery = 'Shape of You';
        $bot = new LyricsBot();
        $results = $bot->searchLyrics($testQuery);
        
        if ($results) {
            echo "<h3>âœ… ØªØ³Øª Ù…ÙˆÙÙ‚!</h3>";
            echo "<p>Ø¬Ø³ØªØ¬ÙˆÛŒ '<strong>" . htmlspecialchars($testQuery) . "</strong>' " . count($results) . " Ù†ØªÛŒØ¬Ù‡ Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯.</p>";
            echo "<h4>Ù†Ù…ÙˆÙ†Ù‡ Ù†ØªØ§ÛŒØ¬:</h4>";
            foreach ($results as $index => $result) {
                echo "<div style='background: rgba(255,255,255,0.1); padding: 10px; margin: 5px; border-radius: 5px;'>";
                echo "<strong>" . ($index + 1) . ".</strong> ";
                echo "<strong>" . htmlspecialchars($result['artist']) . "</strong> - " . htmlspecialchars($result['title']);
                echo "<br><small>Ù…Ù†Ø¨Ø¹: " . ($result['source'] ?? 'unknown') . "</small>";
                echo "</div>";
            }
        } else {
            echo "<h3>âš ï¸ ØªØ³Øª Ø¬Ø³ØªØ¬Ùˆ</h3>";
            echo "<p>Ø³ÛŒØ³ØªÙ… Ø¯Ø± Ø­Ø§Ù„ ØªØ³Øª Ø§Ø³Øª. Ù…Ù…Ú©Ù† Ø§Ø³Øª Ú©Ù…ÛŒ Ø·ÙˆÙ„ Ø¨Ú©Ø´Ø¯.</p>";
            echo "<p>Ø¯Ø± ØªÙ„Ú¯Ø±Ø§Ù… Ø±Ø¨Ø§Øª Ø±Ø§ Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†ÛŒØ¯.</p>";
        }
    }
}
?>
