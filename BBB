<?php
ini_set('display_errors', '1');
ini_set('display_startup_errors', '1');
error_reporting(E_ALL);

// ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ØµÙ„ÛŒ
define('BOT_TOKEN', '7735298785:AAEoKk3OtpUe_0YmYuGkS0k0hhOMGwZe2Vw');
define('ADMIN_ID', 5107034738);
define('MAX_LYRICS_LENGTH', 4000);
define('LOG_FILE', 'bot_logs.log');
define('DB_FILE', 'data/bot_db.json');
define('CACHE_DIR', 'data/cache');
define('CACHE_EXPIRE_TIME', 86400);

// Google API Key
define('GOOGLE_API_KEY', 'AIzaSyAA38-fXEIR1IZILc9MeUQoZBmC3MU89no');
define('GOOGLE_SE_ID', 'd73c8c15c9c244b84');

// Ø§ÛŒØ¬Ø§Ø¯ Ø³Ø§Ø®ØªØ§Ø± Ù¾ÙˆØ´Ù‡â€ŒÙ‡Ø§
if (!file_exists('data')) mkdir('data', 0755, true);
if (!file_exists(CACHE_DIR)) mkdir(CACHE_DIR, 0755, true);

class LyricsBot {
    private $db;
    private $userStates = [];
    private $searchResults = [];
    
    public function __construct() {
        $this->initializeDatabase();
    }
    
    private function initializeDatabase() {
        if (!file_exists(DB_FILE)) {
            $this->db = [
                'users' => [],
                'stats' => [
                    'searches' => 0,
                    'cache_hits' => 0,
                    'users' => 0
                ],
                'settings' => [
                    'bot_active' => true,
                    'maintenance' => false
                ]
            ];
            $this->saveDatabase();
        } else {
            $json = file_get_contents(DB_FILE);
            $this->db = json_decode($json, true);
            if ($this->db === null) {
                $this->db = [
                    'users' => [],
                    'stats' => [
                        'searches' => 0,
                        'cache_hits' => 0,
                        'users' => 0
                    ],
                    'settings' => [
                        'bot_active' => true,
                        'maintenance' => false
                    ]
                ];
            }
        }
    }
    
    private function saveDatabase() {
        file_put_contents(DB_FILE, json_encode($this->db, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE));
    }
    
    private function log($message) {
        $log = "[" . date('Y-m-d H:i:s') . "] " . $message . "\n";
        file_put_contents(LOG_FILE, $log, FILE_APPEND);
    }
    
    private function sendTelegramRequest($method, $params = []) {
        $url = "https://api.telegram.org/bot" . BOT_TOKEN . "/" . $method;
        
        $ch = curl_init();
        curl_setopt($ch, CURLOPT_URL, $url);
        curl_setopt($ch, CURLOPT_POST, true);
        curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($params));
        curl_setopt($ch, CURLOPT_HTTPHEADER, ['Content-Type: application/json']);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
        curl_setopt($ch, CURLOPT_TIMEOUT, 10);
        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
        curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, false);
        
        $response = curl_exec($ch);
        $error = curl_error($ch);
        curl_close($ch);
        
        if ($error) {
            $this->log("CURL Error: " . $error);
            return null;
        }
        
        return json_decode($response, true);
    }
    
    // ============ Ø³ÛŒØ³ØªÙ… Ø¬Ø³ØªØ¬ÙˆÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡ ============
    private function searchLyrics($query) {
        $cacheKey = md5(strtolower($query));
        $cacheFile = CACHE_DIR . '/' . $cacheKey . '.json';
        
        // Ø¨Ø±Ø±Ø³ÛŒ Ú©Ø´
        if (file_exists($cacheFile)) {
            $cacheData = json_decode(file_get_contents($cacheFile), true);
            if ($cacheData && time() - $cacheData['timestamp'] < CACHE_EXPIRE_TIME) {
                $this->db['stats']['cache_hits']++;
                $this->saveDatabase();
                $this->log("Cache hit for: $query");
                return $cacheData['results'];
            }
        }
        
        $this->log("Searching for: $query");
        
        // Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø§ Google API
        $results = $this->searchWithGoogleAPI($query);
        
        if ($results) {
            // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Ú©Ø´
            $cacheData = [
                'timestamp' => time(),
                'results' => $results,
                'query' => $query
            ];
            file_put_contents($cacheFile, json_encode($cacheData));
            
            $this->log("Found " . count($results) . " results for: $query");
        } else {
            $this->log("No results for: $query");
        }
        
        return $results;
    }
    
    private function searchWithGoogleAPI($query) {
        // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ú©Ù„Ù…Ø§Øª Ú©Ù„ÛŒØ¯ÛŒ Ø¨Ø±Ø§ÛŒ Ø¨Ù‡Ø¨ÙˆØ¯ Ù†ØªØ§ÛŒØ¬
        $searchQuery = $query . ' lyrics site:genius.com';
        
        $url = 'https://www.googleapis.com/customsearch/v1?' . http_build_query([
            'key' => GOOGLE_API_KEY,
            'cx' => GOOGLE_SE_ID,
            'q' => $searchQuery,
            'num' => 10,
            'lr' => 'lang_en',
            'gl' => 'us',
            'cr' => 'countryUS'
        ]);
        
        $this->log("Google API Request: " . $url);
        
        $ch = curl_init();
        curl_setopt_array($ch, [
            CURLOPT_URL => $url,
            CURLOPT_RETURNTRANSFER => true,
            CURLOPT_TIMEOUT => 15,
            CURLOPT_SSL_VERIFYPEER => false,
            CURLOPT_USERAGENT => 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
            CURLOPT_HTTPHEADER => [
                'Accept: application/json',
                'Accept-Language: en-US,en;q=0.9'
            ]
        ]);
        
        $response = curl_exec($ch);
        $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
        $error = curl_error($ch);
        curl_close($ch);
        
        if ($error) {
            $this->log("Google API Error: " . $error);
            return null;
        }
        
        if ($httpCode !== 200) {
            $this->log("Google API HTTP $httpCode: " . substr($response, 0, 500));
            return null;
        }
        
        $data = json_decode($response, true);
        
        if (!isset($data['items']) || !is_array($data['items'])) {
            $this->log("No items in response");
            return null;
        }
        
        $results = [];
        $uniqueLinks = [];
        
        foreach ($data['items'] as $index => $item) {
            // ÙÙ‚Ø· Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ÛŒ Genius
            if (!isset($item['link']) || strpos($item['link'], 'genius.com') === false) {
                continue;
            }
            
            // Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ÛŒ ØªÚ©Ø±Ø§Ø±ÛŒ
            if (in_array($item['link'], $uniqueLinks)) {
                continue;
            }
            $uniqueLinks[] = $item['link'];
            
            // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ø·Ù„Ø§Ø¹Ø§Øª
            $title = $item['title'] ?? '';
            $artist = 'Unknown Artist';
            $songTitle = $title;
            
            // Ù¾Ø§Ø±Ø³ Ú©Ø±Ø¯Ù† Ø¹Ù†ÙˆØ§Ù†
            $patterns = [
                '/(.+?)\s*[â€“\-]\s*(.+?)(?:\s*\||\s*Lyrics|$)/i',
                '/(.+?)\s*[:]\s*(.+?)(?:\s*\||\s*Lyrics|$)/i',
                '/(.+?)\s*"\s*(.+?)"(?:\s*\||\s*Lyrics|$)/i',
                '/(.+?)\s*ï½¥\s*(.+?)(?:\s*\||\s*Lyrics|$)/i'
            ];
            
            foreach ($patterns as $pattern) {
                if (preg_match($pattern, $title, $matches)) {
                    $artist = trim($matches[1]);
                    $songTitle = trim($matches[2]);
                    break;
                }
            }
            
            // ØªÙ…ÛŒØ² Ú©Ø±Ø¯Ù† Ø¹Ù†ÙˆØ§Ù†
            $songTitle = preg_replace('/\s*\|\s*Genius.*/i', '', $songTitle);
            $songTitle = preg_replace('/\s*Lyrics.*/i', '', $songTitle);
            $songTitle = preg_replace('/\s*\(.*?\)/', '', $songTitle);
            $songTitle = trim($songTitle);
            
            $artist = preg_replace('/\s*\|\s*Genius.*/i', '', $artist);
            $artist = trim($artist);
            
            // Ø§Ú¯Ø± Ù†ØªÙˆØ§Ù†Ø³ØªÛŒÙ… Ù¾Ø§Ø±Ø³ Ú©Ù†ÛŒÙ…ØŒ Ø¹Ù†ÙˆØ§Ù† Ø§ØµÙ„ÛŒ Ø±Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
            if ($songTitle === $title || empty($songTitle)) {
                $songTitle = $title;
                if (preg_match('/^(.+?)\s*[â€“\-]\s*(.+)$/', $title, $matches)) {
                    $artist = trim($matches[1]);
                    $songTitle = trim($matches[2]);
                }
            }
            
            // Ø¯Ø±ÛŒØ§ÙØª ØªØµÙˆÛŒØ± Ø¨Ù†Ø¯Ø§Ù†Ú¯Ø´ØªÛŒ
            $thumbnail = '';
            if (isset($item['pagemap']['cse_thumbnail'][0]['src'])) {
                $thumbnail = $item['pagemap']['cse_thumbnail'][0]['src'];
            } elseif (isset($item['pagemap']['cse_image'][0]['src'])) {
                $thumbnail = $item['pagemap']['cse_image'][0]['src'];
            }
            
            $results[] = [
                'id' => 'song_' . $index . '_' . time(),
                'title' => $songTitle,
                'artist' => $artist,
                'thumbnail' => $thumbnail,
                'url' => $item['link'],
                'snippet' => $item['snippet'] ?? '',
                'source' => 'genius'
            ];
            
            if (count($results) >= 5) {
                break;
            }
        }
        
        return $results;
    }
    
    private function getSongDetails($songUrl) {
        $cacheKey = md5($songUrl);
        $cacheFile = CACHE_DIR . '/lyrics_' . $cacheKey . '.json';
        
        // Ø¨Ø±Ø±Ø³ÛŒ Ú©Ø´
        if (file_exists($cacheFile)) {
            $cacheData = json_decode(file_get_contents($cacheFile), true);
            if ($cacheData && time() - $cacheData['timestamp'] < CACHE_EXPIRE_TIME) {
                $this->db['stats']['cache_hits']++;
                $this->saveDatabase();
                return $cacheData['lyrics'];
            }
        }
        
        $this->log("Fetching lyrics from: " . $songUrl);
        
        // Ù„ÛŒØ³Øª Ù¾Ø±ÙˆÚ©Ø³ÛŒâ€ŒÙ‡Ø§
        $proxies = [
            'direct' => '', // Ù…Ø³ØªÙ‚ÛŒÙ…
            'allorigins' => 'https://api.allorigins.win/raw?url=',
            'corsproxy' => 'https://corsproxy.io/?',
            'codetabs' => 'https://api.codetabs.com/v1/proxy?quest=',
            'corsanywhere' => 'https://cors-anywhere.herokuapp.com/'
        ];
        
        foreach ($proxies as $proxyName => $proxy) {
            $targetUrl = $proxy ? $proxy . urlencode($songUrl) : $songUrl;
            
            $this->log("Trying proxy: $proxyName - $targetUrl");
            
            $ch = curl_init();
            curl_setopt_array($ch, [
                CURLOPT_URL => $targetUrl,
                CURLOPT_RETURNTRANSFER => true,
                CURLOPT_TIMEOUT => 20,
                CURLOPT_SSL_VERIFYPEER => false,
                CURLOPT_FOLLOWLOCATION => true,
                CURLOPT_USERAGENT => 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
                CURLOPT_HTTPHEADER => [
                    'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',
                    'Accept-Language: en-US,en;q=0.9,fa;q=0.8',
                    'Accept-Encoding: gzip, deflate, br',
                    'Cache-Control: max-age=0'
                ],
                CURLOPT_ENCODING => 'gzip, deflate'
            ]);
            
            $html = curl_exec($ch);
            $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
            $error = curl_error($ch);
            curl_close($ch);
            
            if ($error) {
                $this->log("Proxy $proxyName error: " . $error);
                continue;
            }
            
            if ($httpCode !== 200 || !$html) {
                $this->log("Proxy $proxyName HTTP $httpCode");
                continue;
            }
            
            // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…ØªÙ†
            $lyrics = $this->extractLyricsFromHTML($html);
            
            if ($lyrics && strlen($lyrics) > 100) {
                $this->log("Success with proxy: $proxyName");
                
                // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Ú©Ø´
                $cacheData = [
                    'timestamp' => time(),
                    'lyrics' => $lyrics,
                    'url' => $songUrl
                ];
                file_put_contents($cacheFile, json_encode($cacheData));
                
                return $lyrics;
            }
            
            usleep(300000); // 300ms ØªØ§Ø®ÛŒØ±
        }
        
        return null;
    }
    
    private function extractLyricsFromHTML($html) {
        // Ø±ÙˆØ´â€ŒÙ‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù Ø§Ø³ØªØ®Ø±Ø§Ø¬
        
        // 1. ØªÚ¯ div Ø¨Ø§ Ú©Ù„Ø§Ø³ lyrics
        if (preg_match('/<div[^>]*class="[^"]*lyrics[^"]*"[^>]*>(.*?)<\/div>/is', $html, $matches)) {
            $lyrics = strip_tags($matches[1]);
            $lyrics = preg_replace('/\[.*?\]\s*/', '', $lyrics);
            $lyrics = trim(preg_replace('/\s+/', ' ', $lyrics));
            
            if (strlen($lyrics) > 100) {
                return $lyrics;
            }
        }
        
        // 2. Lyrics__Container
        if (preg_match_all('/<div[^>]*class="[^"]*Lyrics__Container[^"]*"[^>]*>(.*?)<\/div>/is', $html, $matches)) {
            $lyrics = '';
            foreach ($matches[1] as $match) {
                $text = strip_tags($match);
                $text = preg_replace('/\[.*?\]\s*/', '', $text);
                $lyrics .= trim($text) . "\n\n";
            }
            $lyrics = trim($lyrics);
            
            if (strlen($lyrics) > 100) {
                return $lyrics;
            }
        }
        
        // 3. Ø¬Ø³ØªØ¬ÙˆÛŒ Ú©Ù„ÛŒ
        if (preg_match_all('/<div[^>]*>(.*?)<\/div>/is', $html, $matches)) {
            $longest = '';
            foreach ($matches[1] as $match) {
                $text = strip_tags($match);
                $text = preg_replace('/\[.*?\]\s*/', '', $text);
                $text = trim(preg_replace('/\s+/', ' ', $text));
                
                // Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø¢ÛŒØ§ Ù…ØªÙ† Ø§Ø­ØªÙ…Ø§Ù„ÛŒ Ø´Ø¹Ø± Ø§Ø³Øª
                if (strlen($text) > strlen($longest) && 
                    strlen($text) > 100 &&
                    preg_match('/\b(verse|chorus|bridge|intro|outro|lyric|song)\b/i', $text) === 0) {
                    $longest = $text;
                }
            }
            
            if (strlen($longest) > 100) {
                return $longest;
            }
        }
        
        return null;
    }
    
    // ============ Ø±Ø§Ø¨Ø· Ú©Ø§Ø±Ø¨Ø±ÛŒ ============
    public function showMainMenu($chatId, $userId) {
        $keyboard = [
            'inline_keyboard' => [
                [['text' => 'ğŸ” Ø¬Ø³ØªØ¬ÙˆÛŒ Ù…ØªÙ† Ø¢Ù‡Ù†Ú¯', 'callback_data' => 'search']],
                [['text' => 'ğŸ“Š Ø¢Ù…Ø§Ø± Ø±Ø¨Ø§Øª', 'callback_data' => 'stats']],
                [['text' => 'â„¹ï¸ Ø±Ø§Ù‡Ù†Ù…Ø§', 'callback_data' => 'help']]
            ]
        ];
        
        $text = "ğŸµ *Ø¨Ù‡ Ø±Ø¨Ø§Øª Ø¬Ø³ØªØ¬ÙˆÛŒ Ù…ØªÙ† Ø¢Ù‡Ù†Ú¯ Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯!*\n\n";
        $text .= "Ø¨Ø§ Ø§ÛŒÙ† Ø±Ø¨Ø§Øª Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ù…ØªÙ† Ø¢Ù‡Ù†Ú¯â€ŒÙ‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù Ø±Ø§ Ø§Ø² Genius.com Ù¾ÛŒØ¯Ø§ Ú©Ù†ÛŒØ¯.\n\n";
        $text .= "Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ Ø¬Ø³ØªØ¬Ùˆ Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ Ø²ÛŒØ± Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯:";
        
        $this->sendTelegramRequest('sendMessage', [
            'chat_id' => $chatId,
            'text' => $text,
            'parse_mode' => 'Markdown',
            'reply_markup' => json_encode($keyboard)
        ]);
    }
    
    public function showSearchPanel($chatId) {
        $this->sendTelegramRequest('sendMessage', [
            'chat_id' => $chatId,
            'text' => "ğŸ” *Ø­Ø§Ù„Øª Ø¬Ø³ØªØ¬Ùˆ*\n\nÙ„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ø¢Ù‡Ù†Ú¯ Ùˆ Ø®ÙˆØ§Ù†Ù†Ø¯Ù‡ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯.\n\nÙ…Ø«Ø§Ù„â€ŒÙ‡Ø§:\nâ€¢ Shape of You\nâ€¢ Ø¨ÛŒâ€ŒØ¨ÛŒ Ù¾Ø±Ø³Ù¾ÙˆÙ„ÛŒØ³\nâ€¢ Ed Sheeran Perfect\n\nØ¨Ø±Ø§ÛŒ Ø¨Ø§Ø²Ú¯Ø´Øª Ø§Ø² /cancel Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.",
            'parse_mode' => 'Markdown',
            'reply_markup' => json_encode([
                'inline_keyboard' => [
                    [['text' => 'ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ù†Ùˆ', 'callback_data' => 'menu']]
                ]
            ])
        ]);
    }
    
    public function processSearch($chatId, $userId, $query) {
        // Ø«Ø¨Øª Ú©Ø§Ø±Ø¨Ø±
        if (!isset($this->db['users'][$userId])) {
            $this->db['users'][$userId] = [
                'first_seen' => date('Y-m-d H:i:s'),
                'search_count' => 0
            ];
        }
        
        // Ø§ÙØ²Ø§ÛŒØ´ Ø¢Ù…Ø§Ø±
        $this->db['stats']['searches']++;
        $this->db['users'][$userId]['search_count'] = ($this->db['users'][$userId]['search_count'] ?? 0) + 1;
        $this->db['stats']['users'] = count($this->db['users']);
        $this->saveDatabase();
        
        // Ù¾ÛŒØ§Ù… Ø¯Ø± Ø­Ø§Ù„ Ø¬Ø³ØªØ¬Ùˆ
        $this->sendTelegramRequest('sendMessage', [
            'chat_id' => $chatId,
            'text' => "ğŸ” *Ø¯Ø± Ø­Ø§Ù„ Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø±Ø§ÛŒ:*\n`$query`\n\nÙ„Ø·ÙØ§Ù‹ Ú©Ù…ÛŒ ØµØ¨Ø± Ú©Ù†ÛŒØ¯...",
            'parse_mode' => 'Markdown'
        ]);
        
        // Ø§Ù†Ø¬Ø§Ù… Ø¬Ø³ØªØ¬Ùˆ
        $results = $this->searchLyrics($query);
        
        if (!$results || count($results) === 0) {
            $this->sendTelegramRequest('sendMessage', [
                'chat_id' => $chatId,
                'text' => "âŒ *Ù†ØªÛŒØ¬Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯!*\n\nÙ„Ø·ÙØ§Ù‹:\nâ€¢ Ø§Ù…Ù„Ø§ÛŒ ØµØ­ÛŒØ­ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯\nâ€¢ Ù†Ø§Ù… Ú©Ø§Ù…Ù„â€ŒØªØ± Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯\nâ€¢ ÛŒØ§ Ø¢Ù‡Ù†Ú¯ Ø¯ÛŒÚ¯Ø±ÛŒ Ø¬Ø³ØªØ¬Ùˆ Ú©Ù†ÛŒØ¯",
                'parse_mode' => 'Markdown',
                'reply_markup' => json_encode([
                    'inline_keyboard' => [
                        [['text' => 'ğŸ” Ø¬Ø³ØªØ¬ÙˆÛŒ Ù…Ø¬Ø¯Ø¯', 'callback_data' => 'search']],
                        [['text' => 'ğŸ  Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ', 'callback_data' => 'menu']]
                    ]
                ])
            ]);
            return;
        }
        
        // Ø°Ø®ÛŒØ±Ù‡ Ù†ØªØ§ÛŒØ¬ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±
        $this->searchResults[$userId] = $results;
        
        // Ù†Ù…Ø§ÛŒØ´ Ù†ØªØ§ÛŒØ¬
        $text = "ğŸ” *Ù†ØªØ§ÛŒØ¬ Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø±Ø§ÛŒ:* `$query`\n\n";
        
        $keyboard = [];
        
        foreach ($results as $index => $result) {
            $displayText = ($index + 1) . ". *" . $result['artist'] . "* - " . $result['title'];
            if (strlen($displayText) > 60) {
                $displayText = substr($displayText, 0, 57) . '...';
            }
            
            $text .= ($index + 1) . ". *" . $result['artist'] . "* - " . $result['title'] . "\n";
            
            $keyboard[] = [[
                'text' => ($index + 1) . '. Ø§Ù†ØªØ®Ø§Ø¨',
                'callback_data' => 'select_' . $index
            ]];
        }
        
        $keyboard[] = [
            ['text' => 'ğŸ” Ø¬Ø³ØªØ¬ÙˆÛŒ Ø¬Ø¯ÛŒØ¯', 'callback_data' => 'search'],
            ['text' => 'ğŸ  Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ', 'callback_data' => 'menu']
        ];
        
        $this->sendTelegramRequest('sendMessage', [
            'chat_id' => $chatId,
            'text' => $text,
            'parse_mode' => 'Markdown',
            'reply_markup' => json_encode([
                'inline_keyboard' => $keyboard
            ])
        ]);
    }
    
    public function processSongSelection($chatId, $userId, $songIndex) {
        if (!isset($this->searchResults[$userId][$songIndex])) {
            $this->sendTelegramRequest('sendMessage', [
                'chat_id' => $chatId,
                'text' => "âŒ Ø¢Ù‡Ù†Ú¯ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯."
            ]);
            return;
        }
        
        $song = $this->searchResults[$userId][$songIndex];
        
        $this->sendTelegramRequest('sendMessage', [
            'chat_id' => $chatId,
            'text' => "ğŸ“¥ *Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ù…ØªÙ† Ø¢Ù‡Ù†Ú¯...*\n\nğŸµ *" . $song['artist'] . "*\nğŸ¶ *" . $song['title'] . "*",
            'parse_mode' => 'Markdown'
        ]);
        
        // Ø¯Ø±ÛŒØ§ÙØª Ù…ØªÙ† Ø¢Ù‡Ù†Ú¯
        $lyrics = $this->getSongDetails($song['url']);
        
        if (!$lyrics) {
            // Ø§Ú¯Ø± Ù…ØªÙ† Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯ØŒ Ø§Ø² snippet Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
            $lyrics = $song['snippet'] ?? "Ù…ØªØ£Ø³ÙØ§Ù†Ù‡ Ù…ØªÙ† Ø§ÛŒÙ† Ø¢Ù‡Ù†Ú¯ Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª.\n\nÙ…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¢Ù‡Ù†Ú¯ Ø¯ÛŒÚ¯Ø±ÛŒ Ø±Ø§ Ø¬Ø³ØªØ¬Ùˆ Ú©Ù†ÛŒØ¯.";
        }
        
        // Ø§Ú¯Ø± Ø¹Ú©Ø³ Ø¨Ù†Ø¯Ø§Ù†Ú¯Ø´ØªÛŒ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯ØŒ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†
        if (!empty($song['thumbnail'])) {
            try {
                $this->sendTelegramRequest('sendPhoto', [
                    'chat_id' => $chatId,
                    'photo' => $song['thumbnail'],
                    'caption' => "ğŸµ *" . $song['artist'] . " - " . $song['title'] . "*",
                    'parse_mode' => 'Markdown'
                ]);
            } catch (Exception $e) {
                // Ø§Ú¯Ø± Ø§Ø±Ø³Ø§Ù„ Ø¹Ú©Ø³ Ø¨Ø§ Ù…Ø´Ú©Ù„ Ù…ÙˆØ§Ø¬Ù‡ Ø´Ø¯ØŒ Ø§Ø¯Ø§Ù…Ù‡ Ø¨Ø¯Ù‡
            }
        }
        
        // Ø§Ø±Ø³Ø§Ù„ Ù…ØªÙ† Ø¢Ù‡Ù†Ú¯
        $this->sendLyrics($chatId, $song, $lyrics);
    }
    
    private function sendLyrics($chatId, $song, $lyrics) {
        $header = "ğŸµ *" . $song['artist'] . " - " . $song['title'] . "*\n\n";
        
        // Ø¨Ø±Ø±Ø³ÛŒ Ø·ÙˆÙ„ Ù…ØªÙ†
        if (strlen($lyrics) > 3500) {
            $parts = $this->splitText($lyrics, 3000);
        } else {
            $parts = [$lyrics];
        }
        
        // Ø§Ø±Ø³Ø§Ù„ Ù‚Ø³Ù…Øªâ€ŒÙ‡Ø§
        foreach ($parts as $index => $part) {
            $text = ($index === 0 ? $header : '') . $part;
            
            $replyMarkup = null;
            if ($index === count($parts) - 1) {
                $replyMarkup = [
                    'inline_keyboard' => [
                        [['text' => 'ğŸ” Ø¬Ø³ØªØ¬ÙˆÛŒ Ø¬Ø¯ÛŒØ¯', 'callback_data' => 'search']],
                        [['text' => 'ğŸ  Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ', 'callback_data' => 'menu']]
                    ]
                ];
            }
            
            $this->sendTelegramRequest('sendMessage', [
                'chat_id' => $chatId,
                'text' => $text,
                'parse_mode' => 'Markdown',
                'reply_markup' => $replyMarkup ? json_encode($replyMarkup) : null
            ]);
            
            usleep(500000); // Ù†ÛŒÙ… Ø«Ø§Ù†ÛŒÙ‡ ØªØ§Ø®ÛŒØ± Ø¨ÛŒÙ† Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§
        }
    }
    
    private function splitText($text, $maxLength) {
        $parts = [];
        $lines = explode("\n", $text);
        $currentPart = '';
        
        foreach ($lines as $line) {
            if (strlen($currentPart) + strlen($line) + 1 > $maxLength) {
                if (!empty($currentPart)) {
                    $parts[] = $currentPart;
                    $currentPart = $line;
                } else {
                    // Ø§Ú¯Ø± Ø®Ø· Ø®ÛŒÙ„ÛŒ Ø·ÙˆÙ„Ø§Ù†ÛŒ Ø§Ø³Øª
                    while (strlen($line) > $maxLength) {
                        $parts[] = substr($line, 0, $maxLength);
                        $line = substr($line, $maxLength);
                    }
                    $currentPart = $line;
                }
            } else {
                $currentPart .= (empty($currentPart) ? $line : "\n" . $line);
            }
        }
        
        if (!empty($currentPart)) {
            $parts[] = $currentPart;
        }
        
        return $parts;
    }
    
    public function showStats($chatId) {
        $stats = $this->db['stats'];
        $totalUsers = count($this->db['users']);
        
        $text = "ğŸ“Š *Ø¢Ù…Ø§Ø± Ø±Ø¨Ø§Øª*\n\n";
        $text .= "ğŸ‘¥ ØªØ¹Ø¯Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†: *" . number_format($totalUsers) . "*\n";
        $text .= "ğŸ” ØªØ¹Ø¯Ø§Ø¯ Ø¬Ø³ØªØ¬ÙˆÙ‡Ø§: *" . number_format($stats['searches']) . "*\n";
        $text .= "ğŸ’¾ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ú©Ø´: *" . number_format($stats['cache_hits']) . "*\n";
        $text .= "ğŸ“… Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: *" . date('Y-m-d H:i:s') . "*\n\n";
        
        $text .= "âš™ï¸ *ÙˆØ¶Ø¹ÛŒØª Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§:*\n";
        $text .= "â€¢ Google API: âœ… ÙØ¹Ø§Ù„\n";
        $text .= "â€¢ Genius.com: âœ… Ø¯Ø± Ø¯Ø³ØªØ±Ø³\n";
        $text .= "â€¢ Ú©Ø´: âœ… ÙØ¹Ø§Ù„\n";
        
        $this->sendTelegramRequest('sendMessage', [
            'chat_id' => $chatId,
            'text' => $text,
            'parse_mode' => 'Markdown',
            'reply_markup' => json_encode([
                'inline_keyboard' => [
                    [['text' => 'ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª', 'callback_data' => 'menu']]
                ]
            ])
        ]);
    }
    
    public function showHelp($chatId) {
        $text = "â„¹ï¸ *Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø±Ø¨Ø§Øª*\n\n";
        $text .= "ğŸµ *Ø§ÛŒÙ† Ø±Ø¨Ø§Øª Ú†Ù‡ Ú©Ø§Ø±ÛŒ Ø§Ù†Ø¬Ø§Ù… Ù…ÛŒâ€ŒØ¯Ù‡Ø¯ØŸ*\n";
        $text .= "Ø§ÛŒÙ† Ø±Ø¨Ø§Øª Ù…ØªÙ† Ø¢Ù‡Ù†Ú¯â€ŒÙ‡Ø§ Ø±Ø§ Ø§Ø² ÙˆØ¨â€ŒØ³Ø§ÛŒØª Genius.com Ø¬Ø³ØªØ¬Ùˆ Ùˆ Ù†Ù…Ø§ÛŒØ´ Ù…ÛŒâ€ŒØ¯Ù‡Ø¯.\n\n";
        
        $text .= "ğŸ“ *Ø·Ø±ÛŒÙ‚Ù‡ Ø§Ø³ØªÙØ§Ø¯Ù‡:*\n";
        $text .= "1. Ø±ÙˆÛŒ 'Ø¬Ø³ØªØ¬ÙˆÛŒ Ù…ØªÙ† Ø¢Ù‡Ù†Ú¯' Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯\n";
        $text .= "2. Ù†Ø§Ù… Ø¢Ù‡Ù†Ú¯ ÛŒØ§ Ø®ÙˆØ§Ù†Ù†Ø¯Ù‡ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯\n";
        $text .= "3. Ø§Ø² Ù„ÛŒØ³Øª Ù†ØªØ§ÛŒØ¬ØŒ Ø¢Ù‡Ù†Ú¯ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯\n";
        $text .= "4. Ù…ØªÙ† Ú©Ø§Ù…Ù„ Ø¢Ù‡Ù†Ú¯ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯\n\n";
        
        $text .= "ğŸ’¡ *Ù†Ú©Ø§Øª Ù…Ù‡Ù…:*\n";
        $text .= "â€¢ Ø¨Ø±Ø§ÛŒ Ù†ØªØ§ÛŒØ¬ Ø¨Ù‡ØªØ±ØŒ Ù†Ø§Ù… Ú©Ø§Ù…Ù„ Ø¢Ù‡Ù†Ú¯ Ùˆ Ø®ÙˆØ§Ù†Ù†Ø¯Ù‡ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯\n";
        $text .= "â€¢ Ù‡Ù… ÙØ§Ø±Ø³ÛŒ Ùˆ Ù‡Ù… Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯\n";
        $text .= "â€¢ Ø§Ø² Ú©Ù„Ù…Ø§Øª Ú©Ù„ÛŒØ¯ÛŒ Ù…Ù†Ø§Ø³Ø¨ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯\n";
        $text .= "â€¢ Ù†ØªØ§ÛŒØ¬ Ø§Ø² Genius.com Ø¯Ø±ÛŒØ§ÙØª Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯\n\n";
        
        $text .= "âš ï¸ *Ù…Ø­Ø¯ÙˆØ¯ÛŒØªâ€ŒÙ‡Ø§:*\n";
        $text .= "â€¢ Ø­Ø¯Ø§Ú©Ø«Ø± 100 Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ø±ÙˆØ² (Ø±Ø§ÛŒÚ¯Ø§Ù†)\n";
        $text .= "â€¢ Ø¨Ø¹Ø¶ÛŒ Ø¢Ù‡Ù†Ú¯â€ŒÙ‡Ø§ Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†Ø¨Ø§Ø´Ù†Ø¯\n";
        $text .= "â€¢ Ú©ÛŒÙÛŒØª Ù†ØªØ§ÛŒØ¬ Ø¨Ù‡ Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø³ØªÚ¯ÛŒ Ø¯Ø§Ø±Ø¯\n";
        
        $this->sendTelegramRequest('sendMessage', [
            'chat_id' => $chatId,
            'text' => $text,
            'parse_mode' => 'Markdown',
            'reply_markup' => json_encode([
                'inline_keyboard' => [
                    [['text' => 'ğŸ” Ø´Ø±ÙˆØ¹ Ø¬Ø³ØªØ¬Ùˆ', 'callback_data' => 'search']],
                    [['text' => 'ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª', 'callback_data' => 'menu']]
                ]
            ])
        ]);
    }
    
    // ============ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø§ØµÙ„ÛŒ ============
    public function processUpdate($update) {
        try {
            if (isset($update['message'])) {
                $this->processMessage($update['message']);
            } elseif (isset($update['callback_query'])) {
                $this->processCallbackQuery($update['callback_query']);
            }
        } catch (Exception $e) {
            $this->log("Error: " . $e->getMessage());
        }
    }
    
    private function processMessage($message) {
        $chatId = $message['chat']['id'];
        $userId = $message['from']['id'];
        $text = $message['text'] ?? '';
        
        if (strpos($text, '/start') === 0) {
            $this->showMainMenu($chatId, $userId);
        } elseif (strpos($text, '/search') === 0) {
            $query = trim(str_replace('/search', '', $text));
            if ($query) {
                $this->processSearch($chatId, $userId, $query);
            } else {
                $this->showSearchPanel($chatId);
            }
        } elseif (strpos($text, '/stats') === 0) {
            $this->showStats($chatId);
        } elseif (strpos($text, '/help') === 0) {
            $this->showHelp($chatId);
        } elseif (isset($this->userStates[$userId]) && $this->userStates[$userId] === 'awaiting_search') {
            $this->processSearch($chatId, $userId, $text);
            $this->userStates[$userId] = null;
        } else {
            // Ø§Ú¯Ø± Ù¾ÛŒØ§Ù… Ù…Ø¹Ù…ÙˆÙ„ÛŒ Ø§Ø³ØªØŒ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ù†Ø¸Ø± Ø¨Ú¯ÛŒØ±
            if (strlen($text) > 2 && strlen($text) < 100) {
                $this->processSearch($chatId, $userId, $text);
            } else {
                $this->sendTelegramRequest('sendMessage', [
                    'chat_id' => $chatId,
                    'text' => "ğŸµ *Ø±Ø¨Ø§Øª Ø¬Ø³ØªØ¬ÙˆÛŒ Ù…ØªÙ† Ø¢Ù‡Ù†Ú¯*\n\nØ¨Ø±Ø§ÛŒ Ø¬Ø³ØªØ¬Ùˆ:\nâ€¢ Ø§Ø² Ø¯Ú©Ù…Ù‡ 'Ø¬Ø³ØªØ¬ÙˆÛŒ Ù…ØªÙ† Ø¢Ù‡Ù†Ú¯' Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯\nâ€¢ ÛŒØ§ Ø¯Ø³ØªÙˆØ± /search Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯\nâ€¢ ÛŒØ§ Ù…Ø³ØªÙ‚ÛŒÙ…Ø§Ù‹ Ù†Ø§Ù… Ø¢Ù‡Ù†Ú¯ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯",
                    'parse_mode' => 'Markdown',
                    'reply_markup' => json_encode([
                        'inline_keyboard' => [
                            [['text' => 'ğŸ” Ø¬Ø³ØªØ¬ÙˆÛŒ Ù…ØªÙ† Ø¢Ù‡Ù†Ú¯', 'callback_data' => 'search']],
                            [['text' => 'ğŸ“Š Ø¢Ù…Ø§Ø±', 'callback_data' => 'stats']],
                            [['text' => 'â„¹ï¸ Ø±Ø§Ù‡Ù†Ù…Ø§', 'callback_data' => 'help']]
                        ]
                    ])
                ]);
            }
        }
    }
    
    private function processCallbackQuery($callbackQuery) {
        $message = $callbackQuery['message'];
        $chatId = $message['chat']['id'];
        $userId = $callbackQuery['from']['id'];
        $data = $callbackQuery['data'];
        
        // Ù¾Ø§Ø³Ø® Ø¨Ù‡ callback
        $this->sendTelegramRequest('answerCallbackQuery', [
            'callback_query_id' => $callbackQuery['id']
        ]);
        
        if ($data === 'menu') {
            $this->showMainMenu($chatId, $userId);
        } elseif ($data === 'search') {
            $this->showSearchPanel($chatId);
        } elseif ($data === 'stats') {
            $this->showStats($chatId);
        } elseif ($data === 'help') {
            $this->showHelp($chatId);
        } elseif (strpos($data, 'select_') === 0) {
            $index = intval(str_replace('select_', '', $data));
            $this->processSongSelection($chatId, $userId, $index);
        }
    }
}

// Ø§Ø¬Ø±Ø§ÛŒ Ø±Ø¨Ø§Øª
$bot = new LyricsBot();
$update = json_decode(file_get_contents('php://input'), true);

if ($update) {
    $bot->processUpdate($update);
} else {
    // ØµÙØ­Ù‡ ØªØ³Øª Ùˆ Ø§Ø·Ù„Ø§Ø¹Ø§Øª
    echo "<!DOCTYPE html>
    <html lang='fa'>
    <head>
        <meta charset='UTF-8'>
        <meta name='viewport' content='width=device-width, initial-scale=1.0'>
        <title>ğŸµ Ø±Ø¨Ø§Øª Ø¬Ø³ØªØ¬ÙˆÛŒ Ù…ØªÙ† Ø¢Ù‡Ù†Ú¯</title>
        <style>
            body {
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                max-width: 800px;
                margin: 0 auto;
                padding: 20px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                color: white;
            }
            .container {
                background: rgba(255, 255, 255, 0.1);
                backdrop-filter: blur(10px);
                border-radius: 20px;
                padding: 40px;
                margin-top: 50px;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            }
            h1 {
                text-align: center;
                margin-bottom: 30px;
                font-size: 2.5em;
            }
            .status {
                background: rgba(255, 255, 255, 0.2);
                border-radius: 10px;
                padding: 20px;
                margin: 20px 0;
            }
            .status-item {
                display: flex;
                justify-content: space-between;
                margin: 10px 0;
                padding: 10px;
                background: rgba(255, 255, 255, 0.1);
                border-radius: 5px;
            }
            .success {
                color: #4ade80;
            }
            .error {
                color: #f87171;
            }
            .test-btn {
                display: block;
                width: 100%;
                padding: 15px;
                background: #4f46e5;
                color: white;
                border: none;
                border-radius: 10px;
                font-size: 18px;
                cursor: pointer;
                margin-top: 20px;
                transition: background 0.3s;
            }
            .test-btn:hover {
                background: #4338ca;
            }
            .result {
                margin-top: 20px;
                padding: 20px;
                background: rgba(255, 255, 255, 0.1);
                border-radius: 10px;
                display: none;
            }
        </style>
    </head>
    <body>
        <div class='container'>
            <h1>ğŸµ Ø±Ø¨Ø§Øª Ø¬Ø³ØªØ¬ÙˆÛŒ Ù…ØªÙ† Ø¢Ù‡Ù†Ú¯</h1>
            
            <div class='status'>
                <div class='status-item'>
                    <span>Ø±Ø¨Ø§Øª ØªÙ„Ú¯Ø±Ø§Ù…:</span>
                    <span class='success'>âœ… ÙØ¹Ø§Ù„</span>
                </div>
                <div class='status-item'>
                    <span>Google API:</span>";
    
    // ØªØ³Øª Google API
    $testUrl = 'https://www.googleapis.com/customsearch/v1?' . http_build_query([
        'key' => GOOGLE_API_KEY,
        'cx' => GOOGLE_SE_ID,
        'q' => 'test',
        'num' => 1
    ]);
    
    $ch = curl_init();
    curl_setopt_array($ch, [
        CURLOPT_URL => $testUrl,
        CURLOPT_RETURNTRANSFER => true,
        CURLOPT_TIMEOUT => 10,
        CURLOPT_SSL_VERIFYPEER => false
    ]);
    
    $response = curl_exec($ch);
    $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    curl_close($ch);
    
    if ($httpCode == 200) {
        echo "<span class='success'>âœ… Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯</span>";
    } else {
        echo "<span class='error'>âŒ Ø®Ø·Ø§ (Ú©Ø¯: $httpCode)</span>";
    }
    
    echo "</div>
                <div class='status-item'>
                    <span>Ù¾ÙˆØ´Ù‡ Ø¯Ø§Ø¯Ù‡:</span>
                    <span class='success'>âœ… Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯Ù‡</span>
                </div>
                <div class='status-item'>
                    <span>Ø³ÛŒØ³ØªÙ… Ú©Ø´:</span>
                    <span class='success'>âœ… ÙØ¹Ø§Ù„</span>
                </div>
            </div>
            
            <button class='test-btn' onclick='testAPI()'>ØªØ³Øª API</button>
            
            <div class='result' id='apiResult'></div>
            
            <div style='margin-top: 30px; text-align: center;'>
                <p>ğŸ¤– Ø±Ø¨Ø§Øª Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø³Øª!</p>
                <p>Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ØŒ Ø¨Ù‡ Ø±Ø¨Ø§Øª ØªÙ„Ú¯Ø±Ø§Ù… Ù…Ø±Ø§Ø¬Ø¹Ù‡ Ú©Ù†ÛŒØ¯.</p>
            </div>
        </div>
        
        <script>
        function testAPI() {
            const resultDiv = document.getElementById('apiResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = 'ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ ØªØ³Øª...';
            
            fetch('?test=1')
                .then(response => response.text())
                .then(data => {
                    resultDiv.innerHTML = data;
                })
                .catch(error => {
                    resultDiv.innerHTML = 'âŒ Ø®Ø·Ø§ Ø¯Ø± ØªØ³Øª: ' + error;
                });
        }
        </script>
    </body>
    </html>";
    
    // ØªØ³Øª API
    if (isset($_GET['test'])) {
        $testQuery = 'Shape of You';
        $bot = new LyricsBot();
        $results = $bot->searchLyrics($testQuery);
        
        if ($results) {
            echo "<h3>âœ… ØªØ³Øª Ù…ÙˆÙÙ‚!</h3>";
            echo "<p>Ø¬Ø³ØªØ¬ÙˆÛŒ '$testQuery' " . count($results) . " Ù†ØªÛŒØ¬Ù‡ Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†Ø¯.</p>";
            echo "<h4>Ù†ØªØ§ÛŒØ¬ Ù†Ù…ÙˆÙ†Ù‡:</h4>";
            foreach (array_slice($results, 0, 3) as $result) {
                echo "<div style='background: rgba(255,255,255,0.1); padding: 10px; margin: 5px; border-radius: 5px;'>";
                echo "<strong>" . htmlspecialchars($result['artist']) . "</strong> - " . htmlspecialchars($result['title']);
                echo "</div>";
            }
        } else {
            echo "<h3>âŒ ØªØ³Øª Ù†Ø§Ù…ÙˆÙÙ‚</h3>";
            echo "<p>Ù„Ø·ÙØ§Ù‹ API Key Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.</p>";
        }
    }
}
?>
